<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RemittanceServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">e-governments collection</a> &gt; <a href="index.source.html" class="el_package">org.egov.collection.service</a> &gt; <span class="el_source">RemittanceServiceImpl.java</span></div><h1>RemittanceServiceImpl.java</h1><pre class="source lang-java linenums">/*
 *    eGov  SmartCity eGovernance suite aims to improve the internal efficiency,transparency,
 *    accountability and the service delivery of the government  organizations.
 *
 *     Copyright (C) 2017  eGovernments Foundation
 *
 *     The updated version of eGov suite of products as by eGovernments Foundation
 *     is available at http://www.egovernments.org
 *
 *     This program is free software: you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation, either version 3 of the License, or
 *     any later version.
 *
 *     This program is distributed in the hope that it will be useful,
 *     but WITHOUT ANY WARRANTY; without even the implied warranty of
 *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *     GNU General Public License for more details.
 *
 *     You should have received a copy of the GNU General Public License
 *     along with this program. If not, see http://www.gnu.org/licenses/ or
 *     http://www.gnu.org/licenses/gpl.html .
 *
 *     In addition to the terms of the GPL license to be adhered to in using this
 *     program, the following additional terms are to be complied with:
 *
 *         1) All versions of this program, verbatim or modified must carry this
 *            Legal Notice.
 *            Further, all user interfaces, including but not limited to citizen facing interfaces,
 *            Urban Local Bodies interfaces, dashboards, mobile applications, of the program and any
 *            derived works should carry eGovernments Foundation logo on the top right corner.
 *
 *            For the logo, please refer http://egovernments.org/html/logo/egov_logo.png.
 *            For any further queries on attribution, including queries on brand guidelines,
 *            please contact contact@egovernments.org
 *
 *         2) Any misrepresentation of the origin of the material is prohibited. It
 *            is required that all modified versions of this material be marked in
 *            reasonable ways as different from the original version.
 *
 *         3) This license does not grant any rights to any user of the program
 *            with regards to rights under trademark law for use of the trade names
 *            or trademarks of eGovernments Foundation.
 *
 *   In case of any queries, you can reach eGovernments Foundation at contact@egovernments.org.
 *
 */

package org.egov.collection.service;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.egov.billsaccounting.services.VoucherConstant;
import org.egov.collection.bean.ReceiptBean;
import org.egov.collection.constants.CollectionConstants;
import org.egov.collection.entity.BranchUserMap;
import org.egov.collection.entity.ReceiptHeader;
import org.egov.collection.entity.Remittance;
import org.egov.collection.entity.RemittanceDetail;
import org.egov.collection.entity.RemittanceInstrument;
import org.egov.collection.integration.services.RemittanceSchedulerService;
import org.egov.collection.utils.CollectionsNumberGenerator;
import org.egov.collection.utils.CollectionsUtil;
import org.egov.collection.utils.FinancialsUtil;
import org.egov.commons.Bankaccount;
import org.egov.commons.CFinancialYear;
import org.egov.commons.CVoucherHeader;
import org.egov.commons.EgwStatus;
import org.egov.commons.Fund;
import org.egov.commons.dao.ChartOfAccountsDAO;
import org.egov.commons.dao.FunctionHibernateDAO;
import org.egov.commons.dao.FundHibernateDAO;
import org.egov.infra.admin.master.service.DepartmentService;															 
import org.egov.infra.config.core.ApplicationThreadLocals;
import org.egov.infra.microservice.models.BillDetail;
import org.egov.infra.microservice.models.BillDetailAdditional;
import org.egov.infra.microservice.models.BusinessService;
import org.egov.infra.microservice.models.BusinessServiceCriteria;
import org.egov.infra.microservice.models.BusinessServiceMapping;
import org.egov.infra.microservice.models.Department;
import org.egov.infra.microservice.models.Instrument;
import org.egov.infra.microservice.models.InstrumentAccountCode;
import org.egov.infra.microservice.models.InstrumentResponse;
import org.egov.infra.microservice.models.PaymentStatusEnum;
import org.egov.infra.microservice.models.PaymentWorkflow;
import org.egov.infra.microservice.models.Receipt;
import org.egov.infra.microservice.models.RemitancePOJO;
import org.egov.infra.microservice.models.MisRemittanceDetails;
import org.egov.infra.microservice.models.RemittanceReceipt;
import org.egov.infra.microservice.models.RemittanceResponse;
import org.egov.infra.microservice.utils.MicroserviceUtils;
import org.egov.infra.persistence.entity.AbstractAuditable;
import org.egov.infra.utils.DateUtils;
import org.egov.infra.validation.exception.ValidationError;
import org.egov.infra.validation.exception.ValidationException;
import org.egov.infstr.models.ServiceDetails;
import org.egov.infstr.services.PersistenceService;
import org.egov.model.instrument.InstrumentHeader;
import org.egov.services.voucher.VoucherService;
import org.hibernate.Query;
import org.hibernate.SQLQuery;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.transaction.annotation.Transactional;

import com.fasterxml.jackson.databind.JsonNode;

@Transactional(readOnly = true)
<span class="nc" id="L126">public class RemittanceServiceImpl extends RemittanceService {</span>
    private static final long serialVersionUID = 5581301494846870670L;
<span class="nc" id="L128">    private static final Logger LOGGER = Logger.getLogger(ReceiptHeaderService.class);</span>
    private CollectionsUtil collectionsUtil;
    private FinancialsUtil financialsUtil;
    private ReceiptHeaderService receiptHeaderService;
    private PersistenceService persistenceService;
    private CollectionsNumberGenerator collectionsNumberGenerator;
    
<span class="nc" id="L135">	public static final Locale LOCALE = new Locale(&quot;en&quot;, &quot;IN&quot;);</span>
<span class="nc" id="L136">	public static final SimpleDateFormat DDMMYYYYFORMAT1 = new SimpleDateFormat(&quot;dd/MMM/yyyy&quot;, LOCALE);</span>
	
    @Autowired
    private FundHibernateDAO fundHibernateDAO;
    @Autowired
    private FunctionHibernateDAO functionHibernateDAO;
    @Autowired
	private DepartmentService departmentService;
    @Autowired
    private ChartOfAccountsDAO chartOfAccountsDAO;
    private PersistenceService&lt;Remittance, Long&gt; remittancePersistService;
    @Autowired
    @Qualifier(&quot;branchUserMapService&quot;)
    private PersistenceService&lt;BranchUserMap, Long&gt; branchUserMapService;
    @Autowired
    @Qualifier(&quot;remittanceInstrumentService&quot;)
    private PersistenceService&lt;RemittanceInstrument, Long&gt; remittanceInstrumentService;
    @Autowired
    private transient RemittanceSchedulerService remittanceSchedulerService;
    @Autowired
    private MicroserviceUtils microserviceUtils;
    
    @Autowired
    @Qualifier(&quot;misRemittanceDetailService&quot;)
    private MisRemittanceDetailService misRemittanceDetailService;
    
<span class="nc" id="L162">    private List resultList = new ArrayList();</span>
<span class="nc" id="L163">    Map&lt;String, String&gt; serviceCategoryNames = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L164">    Map&lt;String, Map&lt;String, String&gt;&gt; serviceTypeMap = new HashMap&lt;&gt;();</span>
    
    /**
     * Create Contra Vouchers
     *
     * @return List of Contra Vouchers Created
     */
    
    @Transactional
    public ReceiptBean createCashBankRemittance(ReceiptBean receiptBean, List&lt;RemitancePOJO&gt; rp, Date remittanceDate, String narration, String deptIdnew, String functionNew, String receiptNumbers) {   

<span class="nc" id="L175">        final SimpleDateFormat dateFomatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;, Locale.getDefault());</span>
<span class="nc" id="L176">        InstrumentAccountCode accountCode = microserviceUtils.getInstrumentAccountGlCodeByType(CollectionConstants.INSTRUMENTTYPE_NAME_CASH);</span>
<span class="nc" id="L177">        final String cashInHandQueryString = &quot;SELECT COA.GLCODE FROM CHARTOFACCOUNTS COA WHERE COA.GLCODE = '&quot;</span>
<span class="nc" id="L178">                + accountCode.getGlcode()+ &quot;'&quot;;</span>
<span class="nc" id="L179">        final Query cashInHand = persistenceService.getSession().createSQLQuery(cashInHandQueryString);</span>
<span class="nc" id="L180">        String cashInHandGLCode = null;</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (!cashInHand.list().isEmpty())</span>
<span class="nc" id="L183">            cashInHandGLCode = cashInHand.list().get(0).toString();</span>

<span class="nc" id="L185">        Map&lt;String,BigDecimal&gt; bankAccountMap=new HashMap&lt;String,BigDecimal&gt;();</span>
<span class="nc" id="L186">        BigDecimal amt=null;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        for(RemitancePOJO row:rp)</span>
        {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        	if(bankAccountMap.get(row.getBankaccount()) == null )</span>
        	{
<span class="nc" id="L191">        		amt=new BigDecimal(row.getAmount());</span>
<span class="nc" id="L192">        		bankAccountMap.put(row.getBankaccount(),amt);</span>
        	}
        	else
        	{
<span class="nc" id="L196">        		BigDecimal total=bankAccountMap.get(row.getBankaccount()).add(new BigDecimal(row.getAmount()));</span>
<span class="nc" id="L197">        		bankAccountMap.put(row.getBankaccount(), total);</span>
        	}
<span class="nc" id="L199">        }</span>

<span class="nc" id="L201">        String createVoucher = &quot;N&quot;;</span>
<span class="nc" id="L202">        Boolean showRemitDate = true;</span>
<span class="nc" id="L203">        BigDecimal totalCashVoucherAmt = BigDecimal.ZERO;</span>
<span class="nc" id="L204">        String fundCode = &quot;&quot;;</span>
<span class="nc" id="L205">        Date voucherDate = null;</span>
<span class="nc" id="L206">        List&lt;Bankaccount&gt; depositedBankAccount = new ArrayList&lt;Bankaccount&gt;();</span>
<span class="nc" id="L207">        Bankaccount b=null;</span>
<span class="nc" id="L208">        Set&lt;String&gt; keys=bankAccountMap.keySet();</span>
<span class="nc" id="L209">        Map&lt;String,BigDecimal&gt; serviceGlCodes = new HashMap&lt;String,BigDecimal&gt;();</span>
<span class="nc" id="L210">        List&lt;BigDecimal&gt; totalCashAmt = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L211">        BigDecimal amt1=new BigDecimal(0);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        for(String key : keys)</span>
        {
<span class="nc" id="L214">        	String[] accNum=key.split(&quot;-&quot;);</span>
<span class="nc" id="L215">        	b=(Bankaccount) persistenceService.find(&quot;from Bankaccount where accountnumber=?&quot;,accNum[2]);</span>
<span class="nc" id="L216">        	depositedBankAccount.add(b);</span>
<span class="nc" id="L217">        	amt1=new BigDecimal(bankAccountMap.get(key).toString());</span>
<span class="nc" id="L218">        	totalCashAmt.add(amt1);</span>
<span class="nc" id="L219">        	totalCashVoucherAmt=totalCashVoucherAmt.add(amt1);</span>
<span class="nc" id="L220">        	serviceGlCodes.put(b.getChartofaccounts().getGlcode(),amt1);</span>
<span class="nc" id="L221">        }</span>
        
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (receiptBean.getSelected() != null) {</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">                if (receiptBean.getFund() != null &amp;&amp; !receiptBean.getFund().isEmpty())</span>
                {
<span class="nc bnc" id="L226" title="All 2 branches missed.">                	if(receiptBean.getFund().equalsIgnoreCase(&quot;Municipal (General) Fund&quot;))</span>
<span class="nc" id="L227">                		fundCode=&quot;01&quot;;</span>
                	else
<span class="nc" id="L229">                	fundCode = receiptBean.getFund();</span>
                }
<span class="nc bnc" id="L231" title="All 4 branches missed.">                if (showRemitDate &amp;&amp; remittanceDate != null)</span>
<span class="nc" id="L232">                    voucherDate = remittanceDate;</span>
                else
                {
                	try {
<span class="nc" id="L236">                        voucherDate = collectionsUtil.getRemittanceVoucherDate(dateFomatter.parse(receiptBean.getReceiptDate()));</span>
<span class="nc" id="L237">                    } catch (final ParseException e) {</span>
<span class="nc" id="L238">                        LOGGER.error(&quot;Error Parsing Date&quot;, e);</span>
<span class="nc" id="L239">                    }</span>
                }
<span class="nc bnc" id="L241" title="All 4 branches missed.">                if (receiptBean.getService() != null &amp;&amp; receiptBean.getService().length() &gt; 0) {</span>
                    // If Cash Amount is present
<span class="nc bnc" id="L243" title="All 4 branches missed.">                    if (receiptBean.getInstrumentAmount() != null &amp;&amp; cashInHandGLCode != null) {</span>
<span class="nc" id="L244">                        createVoucher = &quot;Y&quot;;</span>
<span class="nc" id="L245">                        String functionCode=functionNew;//receiptBean.getFunctionCode();</span>
						//String deptCode=receiptBean.getDepartment();												   
                        
<span class="nc" id="L248">                        final Remittance remittance = populateAndPersistRemittanceNew(totalCashAmt, null, fundCode,</span>
                                cashInHandGLCode, null, serviceGlCodes, functionCode, receiptBean, createVoucher,
                                narration,voucherDate, depositedBankAccount, totalCashVoucherAmt, BigDecimal.ZERO, Collections.EMPTY_LIST,
                                null,deptIdnew);
                        
<span class="nc" id="L253">                        receiptBean.setRemittanceReferenceNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L254">                        receiptBean.setRemittanceVouherNumber(remittance.getReferenceVoucherNumber());</span>
<span class="nc" id="L255">                        receiptBean.setVoucherid(remittance.getVoucherid());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                        for(String key : keys)</span>
                        {
                        	try {
<span class="nc" id="L259">	                        MisRemittanceDetails mrd= new MisRemittanceDetails();</span>
<span class="nc" id="L260">	                        mrd.setVoucher_number(remittance.getReferenceVoucherNumber());</span>
<span class="nc" id="L261">	                        mrd.setVoucher_date(voucherDate);</span>
	                        //mrd.setMis_receipt_id(Long.valueOf(receiptBean.getReceiptId()));
<span class="nc" id="L263">	                        mrd.setBankaccount(key);</span>
<span class="nc" id="L264">	                        BigDecimal bankamt=new BigDecimal(bankAccountMap.get(key).toString());</span>
<span class="nc" id="L265">	                        mrd.setAmount(bankamt);</span>
<span class="nc" id="L266">	                        mrd.setDepartment(deptIdnew);</span>
<span class="nc" id="L267">	                        mrd.setFunction(functionCode);</span>
<span class="nc" id="L268">	                        mrd.setNarration(narration);</span>
	                        //mrd.setSubdivison(subdivisonNew);
<span class="nc" id="L270">	                        mrd.setReceiptnumbers(receiptNumbers);</span>
<span class="nc" id="L271">	                        misRemittanceDetailService.create(mrd);</span>
                        	}
<span class="nc" id="L273">                        	catch(Exception e)</span>
                        	{
<span class="nc" id="L275">                        		e.printStackTrace();</span>
<span class="nc" id="L276">                        	}</span>
<span class="nc" id="L277">                        }</span>
                    }
                }
            }
        
<span class="nc" id="L282">        return receiptBean;</span>
    }
    
    @Transactional
    @Override
    public List&lt;Receipt&gt; createCashBankRemittance(List&lt;ReceiptBean&gt; receiptList, final String accountNumberId,
            final Date remittanceDate) {

<span class="nc" id="L290">        final Set&lt;Receipt&gt; bankRemittanceList = new HashSet&lt;&gt;();</span>
<span class="nc" id="L291">        final SimpleDateFormat dateFomatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;, Locale.getDefault());</span>
<span class="nc" id="L292">        Set&lt;String&gt; paymentIdSet = null;</span>
<span class="nc" id="L293">        InstrumentAccountCode accountCode = microserviceUtils</span>
<span class="nc" id="L294">                .getInstrumentAccountGlCodeByType(CollectionConstants.INSTRUMENTTYPE_NAME_CASH);</span>

<span class="nc" id="L296">        final String cashInHandQueryString = &quot;SELECT COA.GLCODE FROM CHARTOFACCOUNTS COA WHERE COA.GLCODE = '&quot;</span>
<span class="nc" id="L297">                + accountCode.getGlcode()</span>
                + &quot;'&quot;;
<span class="nc" id="L299">        final Query cashInHand = persistenceService.getSession().createSQLQuery(cashInHandQueryString);</span>

<span class="nc" id="L301">        String cashInHandGLCode = null;</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (!cashInHand.list().isEmpty())</span>
<span class="nc" id="L304">            cashInHandGLCode = cashInHand.list().get(0).toString();</span>

<span class="nc" id="L306">        String createVoucher = &quot;N&quot;;</span>

<span class="nc" id="L308">        String functionCode = collectionsUtil.getAppConfigValue(CollectionConstants.MODULE_NAME_COLLECTIONS_CONFIG,</span>
                CollectionConstants.APPCONFIG_VALUE_COLLECTION_BANKREMITTANCE_FUNCTIONCODE);
     // TODO : need to make this call to mdms
//        FinancialStatus instrumentStatusNew = microserviceUtils
//                .getInstrumentStatusByCode(CollectionConstants.INSTRUMENT_NEW_STATUS);

<span class="nc" id="L314">        Boolean showRemitDate = true;</span>
<span class="nc" id="L315">        BigDecimal totalCashAmt = BigDecimal.ZERO;</span>
<span class="nc" id="L316">        BigDecimal totalCashVoucherAmt = BigDecimal.ZERO;</span>
<span class="nc" id="L317">        String fundCode = &quot;&quot;;</span>
<span class="nc" id="L318">        Date voucherDate = null;</span>
<span class="nc" id="L319">        String description=&quot;&quot;;</span>
<span class="nc" id="L320">        if (collectionsUtil</span>
<span class="nc" id="L321">                .getAppConfigValue(CollectionConstants.MODULE_NAME_COLLECTIONS_CONFIG,</span>
                        CollectionConstants.APPCONFIG_VALUE_COLLECTION_BANKREMITTANCE_SHOWREMITDATE)
<span class="nc bnc" id="L323" title="All 2 branches missed.">                .equals(CollectionConstants.YES))</span>
<span class="nc" id="L324">            showRemitDate = true;</span>

<span class="nc" id="L326">        final Bankaccount depositedBankAccount = (Bankaccount) persistenceService.find(&quot;from Bankaccount where accountnumber=?&quot;,</span>
                accountNumberId);
<span class="nc" id="L328">        final String serviceGlCode = depositedBankAccount.getChartofaccounts().getGlcode();</span>
        List&lt;Receipt&gt; receipts;
        Set&lt;Instrument&gt; instruments;
<span class="nc" id="L331">        Map&lt;String, Receipt&gt; receiptMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L332">        Map&lt;String, Set&lt;Instrument&gt;&gt; receiptInstrumentMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L333">        final HashSet&lt;String&gt; receiptIds = new HashSet&lt;&gt;(0);</span>
<span class="nc" id="L334">        List&lt;BusinessService&gt; businessServiceList = microserviceUtils.getBusinessService(null);</span>
<span class="nc" id="L335">        Map&lt;String, BusinessService&gt; businessDetailsMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        for (BusinessService bd : businessServiceList) {</span>
<span class="nc" id="L337">            businessDetailsMap.put(bd.getCode(), bd);</span>
<span class="nc" id="L338">        }</span>
        BusinessService businessDetails;
        InstrumentResponse instrumentResponse;
        List&lt;Instrument&gt; instrumentsList;
<span class="nc bnc" id="L342" title="All 2 branches missed.">        for (ReceiptBean receipt : receiptList) {</span>
<span class="nc bnc" id="L343" title="All 4 branches missed.">            if (receipt.getSelected() != null &amp;&amp; receipt.getSelected()) {</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">                if (receipt.getFund() != null &amp;&amp; !receipt.getFund().isEmpty())</span>
                {
<span class="nc bnc" id="L346" title="All 2 branches missed.">                	if(receipt.getFund().equalsIgnoreCase(&quot;Municipal (General) Fund&quot;))</span>
<span class="nc" id="L347">                		fundCode=&quot;01&quot;;</span>
                	else
<span class="nc" id="L349">                	fundCode = receipt.getFund();</span>
                }
<span class="nc bnc" id="L351" title="All 4 branches missed.">                if (showRemitDate &amp;&amp; remittanceDate != null)</span>
<span class="nc" id="L352">                    voucherDate = remittanceDate;</span>
                else
                    try {
<span class="nc" id="L355">                        voucherDate = collectionsUtil.getRemittanceVoucherDate(dateFomatter.parse(receipt.getReceiptDate()));</span>
<span class="nc" id="L356">                    } catch (final ParseException e) {</span>
<span class="nc" id="L357">                        LOGGER.error(&quot;Error Parsing Date&quot;, e);</span>
<span class="nc" id="L358">                    }</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">                if (receipt.getService() != null &amp;&amp; receipt.getService().length() &gt; 0) {</span>
<span class="nc" id="L360">                    businessDetails = businessDetailsMap.get(receipt.getService());</span>
                    // If Cash Amount is present
<span class="nc bnc" id="L362" title="All 4 branches missed.">                    if (receipt.getInstrumentAmount() != null &amp;&amp; cashInHandGLCode != null) {</span>
<span class="nc bnc" id="L363" title="All 9 branches missed.">                        switch (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) {</span>
                        case &quot;V2&quot;:
                        case &quot;VERSION&quot;:
<span class="nc" id="L366">							System.out.println(&quot;PaymentStatusEnum.NEW.name() &quot;+PaymentStatusEnum.NEW.name());</span>
<span class="nc" id="L367">							System.out.println(&quot;service &quot;+receipt.getService());</span>
<span class="nc" id="L368">							System.out.println(&quot;fund &quot;+receipt.getFund());</span>
<span class="nc" id="L369">							System.out.println(&quot;department &quot;+receipt.getDepartment());</span>
<span class="nc" id="L370">							System.out.println(&quot;receiptDate &quot;+receipt.getReceiptDate());</span>
<span class="nc" id="L371">							System.out.println(&quot;receiptNumber &quot;+receipt.getReceiptNumber());</span>
<span class="nc" id="L372">							 receipts = null;/*microserviceUtils.getReceipts(PaymentStatusEnum.NEW.name(),</span>
							 receipt.getService(), receipt.getFund(), receipt.getDepartment(),
							 receipt.getReceiptDate(),receipt.getReceiptNumber()); 
							 if (receipts != null) 
							 { 
								 paymentIdSet = new HashSet&lt;&gt;(); 
								 for (Receipt r : receipts) 
								 { 
									 receiptMap.put(r.getPaymentId(),r); 
									 receiptIds.add(r.getPaymentId());
									 paymentIdSet.add(r.getPaymentId());
								 }
								
							 }
		  */
							 
<span class="nc" id="L388">                            break;</span>

                        default:
<span class="nc" id="L391">                            receipts = microserviceUtils.getReceipts(CollectionConstants.RECEIPT_STATUS_APPROVED,</span>
<span class="nc" id="L392">                                    receipt.getService(),</span>
<span class="nc" id="L393">                                    receipt.getFund(), receipt.getDepartment(), receipt.getReceiptDate());</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                            if (receipts != null) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                                for (Receipt r : receipts) {</span>
<span class="nc" id="L396">                                    receiptMap.put(r.getBill().get(0).getBillDetails().get(0).getReceiptNumber(), r);</span>
<span class="nc" id="L397">                                    receiptIds.add(r.getBill().get(0).getBillDetails().get(0).getId());</span>
<span class="nc" id="L398">                                }</span>
                            }
                            break;
                        }
///comment by abhishek on 14032021
						/*
						 * instrumentsList = microserviceUtils.getInstrumentsByReceiptIds(
						 * CollectionConstants.INSTRUMENTTYPE_NAME_CASH,
						 * CollectionConstants.INSTRUMENT_NEW_STATUS, StringUtils.join(receiptIds,
						 * &quot;,&quot;));
						 */
<span class="nc" id="L409">                        totalCashAmt = totalCashAmt.add(receipt.getInstrumentAmount());</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                        if (businessDetails.isVoucherCreationEnabled()) {</span>
<span class="nc" id="L411">                            createVoucher = &quot;Y&quot;;</span>
<span class="nc" id="L412">                            totalCashVoucherAmt = totalCashVoucherAmt.add(receipt.getInstrumentAmount());</span>
						} /*
							 * else { instrumentResponse =
							 * microserviceUtils.reconcileInstruments(instrumentsList, accountNumberId); }
							 */
                        //comment by Abhishek on 14032021 
                        /*for (Instrument i : instrumentsList) {
                            for (InstrumentVoucher iv : i.getInstrumentVouchers()) {
                                if(iv.getVoucherHeaderId() != null){
                                    if (receiptInstrumentMap.get(iv.getReceiptHeaderId()) != null) {
                                        instruments = new HashSet(receiptInstrumentMap.get(iv.getReceiptHeaderId()));
                                        instruments.add(i);
                                        receiptInstrumentMap.put(iv.getReceiptHeaderId(), instruments);
                                    } else {
                                        receiptInstrumentMap.put(iv.getReceiptHeaderId(), Collections.singleton(i));
                                    }
                                    if(paymentIdSet  != null){
                                        paymentIdSet.add(iv.getReceiptHeaderId());
                                    }
                                    bankRemittanceList.add(receiptMap.get(iv.getReceiptHeaderId()));
                                    List&lt;CVoucherHeader&gt; voucher = this.getVoucher(iv.getVoucherHeaderId());
                                    if(!voucher.isEmpty()){
                                        fundCode = voucher.get(0).getFundId().getCode();
                                        functionCode = voucher.get(0).getVouchermis().getFunction().getCode();
                                    }else{
                                        String validationMessage = &quot;Voucher is not exist for receipt: &quot;+receipt.getReceiptNumber()+&quot;, contact tosystem administrator.&quot;;
                                        throw new ValidationException(Arrays.asList(new ValidationError(validationMessage, validationMessage)));
                                    }
                                }
                            }
                        }
                        */

                    }
                }
            }
<span class="nc" id="L448">        }</span>
        
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (totalCashVoucherAmt.compareTo(totalCashAmt) != 0) {</span>
<span class="nc" id="L451">            String validationMessage = &quot;There is a difference of amount &quot; + totalCashAmt.subtract(totalCashVoucherAmt)</span>
                    + &quot; between bank challan and the remittance voucher , please contact system administrator &quot;;
<span class="nc" id="L453">            throw new ValidationException(Arrays.asList(new ValidationError(validationMessage, validationMessage)));</span>
        }
<span class="nc" id="L455">        String subdivisonNew=&quot;&quot;;</span>
<span class="nc" id="L456">        final Remittance remittance = populateAndPersistRemittance(totalCashAmt, BigDecimal.ZERO, fundCode,</span>
                cashInHandGLCode, null, serviceGlCode, functionCode, bankRemittanceList, createVoucher,
                voucherDate, depositedBankAccount, totalCashVoucherAmt, BigDecimal.ZERO, Collections.EMPTY_LIST,
                receiptInstrumentMap,subdivisonNew);

<span class="nc bnc" id="L461" title="All 9 branches missed.">        switch (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) {</span>
        case &quot;V2&quot;:
        case &quot;VERSION2&quot;:
<span class="nc bnc" id="L464" title="All 2 branches missed.">            if(!paymentIdSet.isEmpty()){</span>
<span class="nc" id="L465">                microserviceUtils.performWorkflow(paymentIdSet,PaymentWorkflow.PaymentAction.REMIT, &quot;Payment got remitted from finance&quot;);</span>
            }
            break;

        default:
<span class="nc bnc" id="L470" title="All 2 branches missed.">            for (final Receipt receiptHeader : bankRemittanceList) {</span>
<span class="nc" id="L471">                receiptHeader.getBill().get(0).getBillDetails().get(0).setStatus(&quot;Remitted&quot;);</span>
<span class="nc" id="L472">                receiptHeader.getInstrument().setTenantId(receiptHeader.getTenantId());</span>
<span class="nc" id="L473">                receiptHeader.getBill().get(0).setPayerName(receiptHeader.getBill().get(0).getPaidBy());</span>
<span class="nc" id="L474">                receiptHeader.setReceiptNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L475">            }</span>
            //ReceiptResponse response = microserviceUtils.updateReceipts(new ArrayList&lt;&gt;(bankRemittanceList));
            break;
        }
        
<span class="nc" id="L480">        List&lt;Instrument&gt; instrumentList = receiptInstrumentMap.values().stream().flatMap(Set::stream).collect(Collectors.toList());</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if(!instrumentList.isEmpty()){</span>
<span class="nc" id="L482">            microserviceUtils.reconcileInstrumentsWithPayinSlipId(instrumentList, accountNumberId,remittance.getVoucherHeader().getVoucherNumber());            </span>
        }
<span class="nc" id="L484">        receiptList.stream().forEach(receipt -&gt; {</span>
<span class="nc" id="L485">            receipt.setRemittanceReferenceNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L486">        });</span>
<span class="nc" id="L487">        return new ArrayList(bankRemittanceList);</span>
    }

    @Transactional
    public CVoucherHeader createVoucherForRemittance(final String cashInHandGLCode, final String chequeInHandGLcode,
            final String serviceGLCode, final String functionCode, final BigDecimal totalCashVoucherAmt,
            final BigDecimal totalChequeVoucherAmt, final Date voucherDate, final String fundCode, final String narration, String subdivisonNew) {
        CVoucherHeader voucherHeader;
<span class="nc" id="L495">        final List&lt;HashMap&lt;String, Object&gt;&gt; accountCodeList = new ArrayList&lt;&gt;(0);</span>
        HashMap&lt;String, Object&gt; accountcodedetailsHashMap;
<span class="nc bnc" id="L497" title="All 4 branches missed.">        if (totalCashVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0 &amp;&amp; !cashInHandGLCode.isEmpty()) {</span>
<span class="nc" id="L498">            accountcodedetailsHashMap = prepareAccountCodeDetails(cashInHandGLCode, functionCode, totalCashVoucherAmt,</span>
                    BigDecimal.ZERO);
<span class="nc" id="L500">            accountCodeList.add(accountcodedetailsHashMap);</span>
        }
<span class="nc bnc" id="L502" title="All 4 branches missed.">        if (totalChequeVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0 &amp;&amp; !chequeInHandGLcode.isEmpty()) {</span>
<span class="nc" id="L503">            accountcodedetailsHashMap = prepareAccountCodeDetails(chequeInHandGLcode, functionCode,</span>
                    totalChequeVoucherAmt, BigDecimal.ZERO);
<span class="nc" id="L505">            accountCodeList.add(accountcodedetailsHashMap);</span>
        }
<span class="nc" id="L507">        final BigDecimal totalDebitAmount = totalChequeVoucherAmt.add(totalCashVoucherAmt);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (!serviceGLCode.isEmpty()) {</span>
<span class="nc" id="L509">            accountcodedetailsHashMap = prepareAccountCodeDetails(serviceGLCode, functionCode, BigDecimal.ZERO,</span>
                    totalDebitAmount);
<span class="nc" id="L511">            accountCodeList.add(accountcodedetailsHashMap);</span>
        }
<span class="nc" id="L513">        voucherHeader = financialsUtil.createRemittanceVoucher(prepareHeaderDetails(fundCode, functionCode, voucherDate,narration,null),</span>
                accountCodeList, new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;(0));
<span class="nc" id="L515">        return voucherHeader;</span>
    }

    @Transactional
    public CVoucherHeader createVoucherForRemittanceNew(final String cashInHandGLCode, final String chequeInHandGLCode,
            final Map&lt;String, BigDecimal&gt; serviceGlCodes, final String functionCode, final List&lt;BigDecimal&gt; totalCashAmount,
            final List&lt;BigDecimal&gt; totalChequeAmount, final Date voucherDate, final String fundCode, final String narration, String deptIdnew) {
        CVoucherHeader voucherHeader;
<span class="nc" id="L523">        final List&lt;HashMap&lt;String, Object&gt;&gt; accountCodeList = new ArrayList&lt;&gt;(0);</span>
        HashMap&lt;String, Object&gt; accountcodedetailsHashMap;
<span class="nc" id="L525">        BigDecimal totalDebitAmount = new BigDecimal(0);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (!serviceGlCodes.isEmpty()) </span>
        {
<span class="nc" id="L528">        	Set&lt;String&gt; keys=serviceGlCodes.keySet();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        	for(String glCode:keys)</span>
        	{
<span class="nc bnc" id="L531" title="All 2 branches missed.">	        	if(!cashInHandGLCode.isEmpty())</span>
	            {
<span class="nc" id="L533">	            	accountcodedetailsHashMap = prepareAccountCodeDetails(glCode, functionCode, BigDecimal.ZERO,serviceGlCodes.get(glCode));</span>
<span class="nc" id="L534">	                    accountCodeList.add(accountcodedetailsHashMap);</span>
<span class="nc" id="L535">	                    totalDebitAmount=totalDebitAmount.add(serviceGlCodes.get(glCode));</span>
	            	
	            }
	        	else //if(!chequeInHandGLCode.isEmpty())
	            {
<span class="nc" id="L540">	            	accountcodedetailsHashMap = prepareAccountCodeDetails(glCode, functionCode, BigDecimal.ZERO, serviceGlCodes.get(glCode));</span>
<span class="nc" id="L541">	                    accountCodeList.add(accountcodedetailsHashMap);</span>
<span class="nc" id="L542">	                    totalDebitAmount=totalDebitAmount.add(serviceGlCodes.get(glCode));</span>
	            }
<span class="nc" id="L544">        	}</span>
        }
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if(!cashInHandGLCode.isEmpty())</span>
        {
<span class="nc" id="L548">        		accountcodedetailsHashMap = prepareAccountCodeDetails(cashInHandGLCode, functionCode, totalDebitAmount,</span>
                        BigDecimal.ZERO);
<span class="nc" id="L550">                accountCodeList.add(accountcodedetailsHashMap);</span>
             
        }
        else //if(!chequeInHandGLCode.isEmpty())
        {
<span class="nc" id="L555">        	accountcodedetailsHashMap = prepareAccountCodeDetails(cashInHandGLCode, functionCode, totalDebitAmount,</span>
                        BigDecimal.ZERO);
<span class="nc" id="L557">                accountCodeList.add(accountcodedetailsHashMap);</span>
        }
		
       
<span class="nc" id="L561">        voucherHeader = financialsUtil.createRemittanceVoucher(prepareHeaderDetails(fundCode, functionCode, voucherDate,narration,deptIdnew),</span>
                accountCodeList, new ArrayList&lt;HashMap&lt;String, Object&gt;&gt;(0));
<span class="nc" id="L563">        return voucherHeader;</span>
    }
    
    @SuppressWarnings(&quot;unchecked&quot;)
    public List&lt;ReceiptHeader&gt; getRemittanceList(final ServiceDetails serviceDetails,
            final List&lt;InstrumentHeader&gt; instrumentHeaderList) {
<span class="nc" id="L569">        final List&lt;Long&gt; instHeaderList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">        for (final InstrumentHeader instHead : instrumentHeaderList)</span>
<span class="nc" id="L571">            instHeaderList.add(instHead.getId());</span>
<span class="nc" id="L572">        final List&lt;ReceiptHeader&gt; bankRemittanceList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L573">        final List&lt;ReceiptHeader&gt; receiptHeaders = persistenceService.findAllByNamedQuery(</span>
<span class="nc" id="L574">                CollectionConstants.QUERY_RECEIPTS_BY_INSTRUMENTHEADER_AND_SERVICECODE, serviceDetails.getCode(),</span>
                instHeaderList);
<span class="nc" id="L576">        bankRemittanceList.addAll(receiptHeaders);</span>
<span class="nc" id="L577">        return bankRemittanceList;</span>
    }

    
    @Transactional
    public Remittance populateAndPersistRemittanceNew(final List&lt;BigDecimal&gt; totalCashAmount, final List&lt;BigDecimal&gt; totalChequeAmount,
            final String fundCode, final String cashInHandGLCode, final String chequeInHandGLcode,
            final Map&lt;String, BigDecimal&gt; serviceGlCodes, final String functionCode, final ReceiptBean receiptBean,
            final String createVoucher,final String narration, final Date voucherDate, final List&lt;Bankaccount&gt; depositedBankAccount,
            final BigDecimal totalCashVoucherAmt, final BigDecimal totalChequeVoucherAmt, List&lt;String&gt; instrumentId,
            Map&lt;String, Set&lt;Instrument&gt;&gt; receiptInstrumentMap, String deptIdnew) {
<span class="nc" id="L588">    	System.out.println(&quot;fundCode &quot;+fundCode);</span>
<span class="nc" id="L589">    	System.out.println(&quot;cashInHandGLCode &quot;+cashInHandGLCode);</span>
<span class="nc" id="L590">    	System.out.println(&quot;chequeInHandGLcode &quot;+chequeInHandGLcode);</span>
<span class="nc" id="L591">    	System.out.println(&quot;serviceGLCode &quot;+serviceGlCodes);</span>
<span class="nc" id="L592">    	System.out.println(&quot;functionCode &quot;+functionCode);</span>
    	
        CVoucherHeader voucherHeader;
<span class="nc" id="L595">        final CFinancialYear financialYear = collectionsUtil.getFinancialYearforDate(new Date());</span>
<span class="nc" id="L596">        BigDecimal totalAmount = BigDecimal.ZERO;</span>
<span class="nc" id="L597">        final Remittance remittance = new Remittance();</span>
<span class="nc" id="L598">        final List&lt;RemittanceDetail&gt; remittanceDetailsList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L599">        Boolean isChequeAmount = Boolean.FALSE;</span>
<span class="nc" id="L600">        remittance.setReferenceDate(voucherDate);</span>
<span class="nc" id="L601">        final EgwStatus receiptStatusApproved = collectionsUtil.getStatusForModuleAndCode(</span>
                CollectionConstants.MODULE_NAME_REMITTANCE, CollectionConstants.REMITTANCE_STATUS_CODE_APPROVED);
<span class="nc" id="L603">        remittance.setStatus(receiptStatusApproved);</span>
<span class="nc" id="L604">        remittance.setReferenceNumber(collectionsNumberGenerator.generateRemittanceNumber(financialYear));</span>
<span class="nc" id="L605">        remittance.setFund(fundHibernateDAO.fundByCode(fundCode));</span>
<span class="nc" id="L606">        remittance.setFunction(functionHibernateDAO.getFunctionByCode(functionCode));</span>
<span class="nc" id="L607">        remittance.setCollectionRemittance(new HashSet&lt;ReceiptHeader&gt;());</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if(totalCashAmount!=null)</span>
        {
<span class="nc bnc" id="L610" title="All 2 branches missed.">        	for(BigDecimal amount:totalCashAmount)</span>
        	{
<span class="nc bnc" id="L612" title="All 2 branches missed.">        		if(totalCashAmount!=null)</span>
        		{
<span class="nc bnc" id="L614" title="All 6 branches missed.">        			if (amount != null &amp;&amp; amount.compareTo(BigDecimal.ZERO) &gt; 0 &amp;&amp; cashInHandGLCode != null) {</span>
<span class="nc" id="L615">    		            remittanceDetailsList</span>
<span class="nc" id="L616">    		                    .addAll(getRemittanceDetailsList(amount, BigDecimal.ZERO, cashInHandGLCode, remittance));</span>
<span class="nc" id="L617">    		            totalAmount = totalAmount.add(amount);</span>
    		        }
        		}
<span class="nc" id="L620">        	}</span>
        }
        else
        {
<span class="nc bnc" id="L624" title="All 2 branches missed.">        	for(BigDecimal amount:totalChequeAmount)</span>
        	{
<span class="nc bnc" id="L626" title="All 2 branches missed.">        		if(totalChequeAmount!=null)</span>
        		{
<span class="nc bnc" id="L628" title="All 6 branches missed.">    			if (amount != null &amp;&amp; amount.compareTo(BigDecimal.ZERO) &gt; 0 &amp;&amp; chequeInHandGLcode != null) {</span>
<span class="nc" id="L629">		            remittanceDetailsList.addAll(</span>
<span class="nc" id="L630">		                    getRemittanceDetailsList(amount, BigDecimal.ZERO, chequeInHandGLcode, remittance));</span>
<span class="nc" id="L631">		            totalAmount = totalAmount.add(amount);</span>
<span class="nc" id="L632">		            isChequeAmount = Boolean.TRUE;</span>
		        }
        		}
<span class="nc" id="L635">        	}</span>
        }
		
<span class="nc" id="L638">        remittanceDetailsList.addAll(getRemittanceDetailsListNew(BigDecimal.ZERO, totalAmount, serviceGlCodes, remittance));</span>
<span class="nc" id="L639">        remittance.setRemittanceDetails(new HashSet&lt;RemittanceDetail&gt;(remittanceDetailsList));</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (CollectionConstants.YES.equalsIgnoreCase(createVoucher)</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                &amp;&amp; (totalCashVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                        || totalChequeVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0)) {</span>
<span class="nc" id="L643">            voucherHeader = createVoucherForRemittanceNew(cashInHandGLCode, chequeInHandGLcode, serviceGlCodes,</span>
                    functionCode, totalCashAmount, totalChequeAmount, voucherDate, fundCode,narration,deptIdnew);
<span class="nc" id="L645">            remittance.setVoucherHeader(voucherHeader);</span>
<span class="nc" id="L646">            remittance.setVoucherid(voucherHeader.getId());</span>
<span class="nc" id="L647">            remittance.setReferenceVoucherNumber(voucherHeader.getVoucherNumber());</span>
        }
        
<span class="nc" id="L650">        return remittance;</span>
    }
    public void applyAuditing(AbstractAuditable auditable) {
<span class="nc" id="L653">		Date currentDate = new Date();</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">		if (auditable.isNew()) {</span>
<span class="nc" id="L655">			auditable.setCreatedBy(ApplicationThreadLocals.getUserId());</span>
<span class="nc" id="L656">			auditable.setCreatedDate(currentDate);</span>
		}
<span class="nc" id="L658">		auditable.setLastModifiedBy(ApplicationThreadLocals.getUserId());</span>
<span class="nc" id="L659">		auditable.setLastModifiedDate(currentDate);</span>
<span class="nc" id="L660">	}</span>
    
    @Transactional
    public Remittance populateAndPersistRemittance(final BigDecimal totalCashAmount, final BigDecimal totalChequeAmount,
            final String fundCode, final String cashInHandGLCode, final String chequeInHandGLcode,
            final String serviceGLCode, final String functionCode, final Set&lt;Receipt&gt; receiptHeadList,
            final String createVoucher, final Date voucherDate, final Bankaccount depositedBankAccount,
            final BigDecimal totalCashVoucherAmt, final BigDecimal totalChequeVoucherAmt, List&lt;String&gt; instrumentId,
            Map&lt;String, Set&lt;Instrument&gt;&gt; receiptInstrumentMap,String subdivisonNew) {
<span class="nc" id="L669">    	System.out.println(&quot;fundCode &quot;+fundCode);</span>
<span class="nc" id="L670">    	System.out.println(&quot;cashInHandGLCode &quot;+cashInHandGLCode);</span>
<span class="nc" id="L671">    	System.out.println(&quot;chequeInHandGLcode &quot;+chequeInHandGLcode);</span>
<span class="nc" id="L672">    	System.out.println(&quot;serviceGLCode &quot;+serviceGLCode);</span>
<span class="nc" id="L673">    	System.out.println(&quot;functionCode &quot;+functionCode);</span>
    	
        CVoucherHeader voucherHeader;
<span class="nc" id="L676">        final CFinancialYear financialYear = collectionsUtil.getFinancialYearforDate(new Date());</span>
<span class="nc" id="L677">        BigDecimal totalAmount = BigDecimal.ZERO;</span>
<span class="nc" id="L678">        final Remittance remittance = new Remittance();</span>
<span class="nc" id="L679">        final List&lt;RemittanceDetail&gt; remittanceDetailsList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L680">        Boolean isChequeAmount = Boolean.FALSE;</span>
<span class="nc" id="L681">        remittance.setReferenceDate(voucherDate);</span>
<span class="nc" id="L682">        final EgwStatus receiptStatusApproved = collectionsUtil.getStatusForModuleAndCode(</span>
                CollectionConstants.MODULE_NAME_REMITTANCE, CollectionConstants.REMITTANCE_STATUS_CODE_APPROVED);
<span class="nc" id="L684">        remittance.setStatus(receiptStatusApproved);</span>
<span class="nc" id="L685">        remittance.setReferenceNumber(collectionsNumberGenerator.generateRemittanceNumber(financialYear));</span>
<span class="nc" id="L686">        remittance.setFund(fundHibernateDAO.fundByCode(fundCode));</span>
<span class="nc" id="L687">        remittance.setFunction(functionHibernateDAO.getFunctionByCode(functionCode));</span>
<span class="nc" id="L688">        remittance.setCollectionRemittance(new HashSet&lt;ReceiptHeader&gt;());</span>
<span class="nc" id="L689">        remittance.setBankAccount(depositedBankAccount);</span>
<span class="nc bnc" id="L690" title="All 6 branches missed.">        if (totalCashAmount != null &amp;&amp; totalCashAmount.compareTo(BigDecimal.ZERO) &gt; 0 &amp;&amp; cashInHandGLCode != null) {</span>
<span class="nc" id="L691">            remittanceDetailsList</span>
<span class="nc" id="L692">                    .addAll(getRemittanceDetailsList(totalCashAmount, BigDecimal.ZERO, cashInHandGLCode, remittance));</span>
<span class="nc" id="L693">            totalAmount = totalAmount.add(totalCashAmount);</span>
        }
<span class="nc bnc" id="L695" title="All 6 branches missed.">        if (totalChequeAmount != null &amp;&amp; totalChequeAmount.compareTo(BigDecimal.ZERO) &gt; 0</span>
                &amp;&amp; chequeInHandGLcode != null) {
<span class="nc" id="L697">            remittanceDetailsList.addAll(</span>
<span class="nc" id="L698">                    getRemittanceDetailsList(totalChequeAmount, BigDecimal.ZERO, chequeInHandGLcode, remittance));</span>
<span class="nc" id="L699">            totalAmount = totalAmount.add(totalChequeAmount);</span>
<span class="nc" id="L700">            isChequeAmount = Boolean.TRUE;</span>
        }
<span class="nc" id="L702">        remittanceDetailsList.addAll(getRemittanceDetailsList(BigDecimal.ZERO, totalAmount, serviceGLCode, remittance));</span>
<span class="nc" id="L703">        remittance.setRemittanceDetails(new HashSet&lt;RemittanceDetail&gt;(remittanceDetailsList));</span>
<span class="nc" id="L704">        HashSet&lt;RemittanceInstrument&gt; remittanceInstrumentSet = new HashSet&lt;RemittanceInstrument&gt;();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (CollectionConstants.YES.equalsIgnoreCase(createVoucher)</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                &amp;&amp; (totalCashVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                        || totalChequeVoucherAmt.compareTo(BigDecimal.ZERO) &gt; 0)) {</span>
<span class="nc" id="L708">            voucherHeader = createVoucherForRemittance(cashInHandGLCode, chequeInHandGLcode, serviceGLCode,</span>
                    functionCode, totalCashVoucherAmt, totalChequeVoucherAmt, voucherDate, fundCode,null,subdivisonNew);
<span class="nc" id="L710">            remittance.setVoucherHeader(voucherHeader);</span>
			/*
			 * for (Receipt receiptHeader : receiptHeadList) { Set&lt;Instrument&gt; instSet =
			 * Collections.EMPTY_SET; switch
			 * (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) { case &quot;V2&quot;:
			 * case &quot;VERSION2&quot;: //instSet =
			 * receiptInstrumentMap.get(receiptHeader.getPaymentId()); break;
			 * 
			 * default: //instSet =
			 * receiptInstrumentMap.get(receiptHeader.getBill().get(0).getBillDetails().get(
			 * 0).getReceiptNumber()); break; } for (Instrument instHead : instSet) { if
			 * (!isChequeAmount || (isChequeAmount &amp;&amp;
			 * instrumentId.contains(instHead.getId().toString()))) { RemittanceInstrument
			 * ri = prepareRemittanceInstrument(remittance, instHead); if (isChequeAmount) {
			 * ri.setReconciled(Boolean.TRUE); } remittanceInstrumentSet.add(ri); }
			 * 
			 * } }
			 */
<span class="nc" id="L728">            remittance.setRemittanceInstruments(remittanceInstrumentSet);</span>
            //RemittanceResponse response = create(remittance, receiptHeadList);
        }
<span class="nc" id="L731">        return remittance;</span>
    }

    private RemittanceResponse create(Remittance remittance, final Set&lt;Receipt&gt; receiptHeadList) {
<span class="nc" id="L735">        org.egov.infra.microservice.models.Remittance r = new org.egov.infra.microservice.models.Remittance();</span>
<span class="nc" id="L736">        r.setBankaccount(remittance.getBankAccount().getAccountnumber());</span>
<span class="nc" id="L737">        r.setFunction(remittance.getFunction().getCode());</span>
<span class="nc" id="L738">        r.setFund(remittance.getFund().getCode());</span>
<span class="nc" id="L739">        r.setReasonForDelay(remittance.getReasonForDelay());</span>
<span class="nc" id="L740">        r.setReferenceNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L741">        r.setStatus(&quot;Approved&quot;);</span>
<span class="nc" id="L742">        r.setReferenceDate(remittance.getReferenceDate().getTime());</span>
<span class="nc" id="L743">        r.setRemarks(remittance.getRemarks());</span>
<span class="nc" id="L744">        r.setTenantId(microserviceUtils.getTenentId());</span>
<span class="nc" id="L745">        r.setVoucherHeader(remittance.getVoucherHeader().getVoucherNumber());</span>
<span class="nc" id="L746">        r.setRemittanceDetails(new HashSet&lt;&gt;());</span>
<span class="nc" id="L747">        r.setRemittanceInstruments(new HashSet&lt;&gt;());</span>
<span class="nc" id="L748">        r.setRemittanceReceipts(new HashSet&lt;&gt;());</span>
        org.egov.infra.microservice.models.RemittanceDetail rd;
<span class="nc bnc" id="L750" title="All 2 branches missed.">        for (RemittanceDetail detail : remittance.getRemittanceDetails()) {</span>
<span class="nc" id="L751">            rd = new org.egov.infra.microservice.models.RemittanceDetail();</span>
<span class="nc" id="L752">            rd.setChartOfAccount(detail.getChartOfAccount().getGlcode());</span>
<span class="nc" id="L753">            rd.setCreditAmount(detail.getCreditAmount());</span>
<span class="nc" id="L754">            rd.setDebitAmount(detail.getDebitAmount());</span>
<span class="nc" id="L755">            rd.setTenantId(microserviceUtils.getTenentId());</span>
<span class="nc" id="L756">            r.getRemittanceDetails().add(rd);</span>
<span class="nc" id="L757">        }</span>
        org.egov.infra.microservice.models.RemittanceInstrument ri;
<span class="nc bnc" id="L759" title="All 2 branches missed.">        for (RemittanceInstrument instrument : remittance.getRemittanceInstruments()) {</span>
<span class="nc" id="L760">            ri = new org.egov.infra.microservice.models.RemittanceInstrument();</span>
<span class="nc" id="L761">            ri.setInstrument(instrument.getInstrument().getId());</span>
<span class="nc" id="L762">            ri.setReconciled(instrument.getReconciled());</span>
<span class="nc" id="L763">            ri.setTenantId(microserviceUtils.getTenentId());</span>
<span class="nc" id="L764">            r.getRemittanceInstruments().add(ri);</span>
<span class="nc" id="L765">        }</span>
        RemittanceReceipt rr;
<span class="nc bnc" id="L767" title="All 2 branches missed.">        for (Receipt receipt : receiptHeadList) {</span>
<span class="nc" id="L768">            rr = new RemittanceReceipt();</span>
<span class="nc" id="L769">            rr.setReceipt(receipt.getBill().get(0).getBillDetails().get(0).getId());</span>
<span class="nc" id="L770">            rr.setTenantId(microserviceUtils.getTenentId());</span>
<span class="nc" id="L771">            r.getRemittanceReceipts().add(rr);</span>
<span class="nc" id="L772">        }</span>
<span class="nc" id="L773">        return microserviceUtils.createRemittance(Collections.singletonList(r));</span>
    }

    private RemittanceInstrument prepareRemittanceInstrument(Remittance remittance, Instrument instrumentHeader) {
<span class="nc" id="L777">        RemittanceInstrument remittanceInstrument = new RemittanceInstrument();</span>
<span class="nc" id="L778">        remittanceInstrument.setRemittance(remittance);</span>
<span class="nc" id="L779">        remittanceInstrument.setInstrument(instrumentHeader);</span>
<span class="nc" id="L780">        remittanceInstrument.setReconciled(Boolean.FALSE);</span>
<span class="nc" id="L781">        return remittanceInstrument;</span>
    }

    public HashMap&lt;String, Object&gt; prepareAccountCodeDetails(final String glCode, final String functionCode,
            final BigDecimal creditAmount, final BigDecimal debitAmount) {
<span class="nc" id="L786">        final HashMap&lt;String, Object&gt; accountcodedetailsHashMap = new HashMap&lt;&gt;(0);</span>
<span class="nc" id="L787">        accountcodedetailsHashMap.put(VoucherConstant.GLCODE, glCode);</span>
<span class="nc" id="L788">        accountcodedetailsHashMap.put(VoucherConstant.FUNCTIONCODE, functionCode);</span>
<span class="nc" id="L789">        accountcodedetailsHashMap.put(VoucherConstant.CREDITAMOUNT, creditAmount);</span>
<span class="nc" id="L790">        accountcodedetailsHashMap.put(VoucherConstant.DEBITAMOUNT, debitAmount);</span>
<span class="nc" id="L791">        return accountcodedetailsHashMap;</span>
    }
    
    public HashMap&lt;String, Object&gt; prepareAccountCodeDetailsNew(final Map&lt;String, String&gt; serviceGlCodes, final String functionCode,
            final BigDecimal creditAmount, final BigDecimal debitAmount) {
<span class="nc" id="L796">        final HashMap&lt;String, Object&gt; accountcodedetailsHashMap = new HashMap&lt;&gt;(0);</span>
<span class="nc" id="L797">        Set&lt;String&gt; keys=serviceGlCodes.keySet();</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">        for(String key : keys)</span>
        { 
<span class="nc" id="L800">        	accountcodedetailsHashMap.put(VoucherConstant.GLCODE, key);</span>
<span class="nc" id="L801">        	accountcodedetailsHashMap.put(VoucherConstant.FUNCTIONCODE, functionCode);</span>
<span class="nc" id="L802">        	accountcodedetailsHashMap.put(VoucherConstant.CREDITAMOUNT, creditAmount);</span>
<span class="nc" id="L803">        	accountcodedetailsHashMap.put(VoucherConstant.DEBITAMOUNT, debitAmount);</span>
<span class="nc" id="L804">        }</span>
<span class="nc" id="L805">        return accountcodedetailsHashMap;</span>
    }

    public HashMap&lt;String, Object&gt; prepareHeaderDetails(final String fundCode, final String functionCode,
            final Date voucherDate,final String narration, String deptIdnew) {
<span class="nc" id="L810">        final HashMap&lt;String, Object&gt; headerdetails = new HashMap&lt;&gt;(0);</span>

        //final String deptCode = departmentService.getDepartmentByCode(deptIdnew).getCode();

<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (collectionsUtil.getVoucherType()) {</span>
<span class="nc" id="L815">            headerdetails.put(VoucherConstant.VOUCHERNAME, CollectionConstants.FINANCIAL_RECEIPTS_VOUCHERNAME);</span>
<span class="nc" id="L816">            headerdetails.put(VoucherConstant.VOUCHERTYPE, CollectionConstants.FINANCIAL_RECEIPTS_VOUCHERTYPE);</span>
        } else {
<span class="nc" id="L818">            headerdetails.put(VoucherConstant.VOUCHERNAME, CollectionConstants.FINANCIAL_CONTRATVOUCHER_VOUCHERNAME);</span>
<span class="nc" id="L819">            headerdetails.put(VoucherConstant.VOUCHERTYPE, CollectionConstants.FINANCIAL_CONTRAVOUCHER_VOUCHERTYPE);</span>
        }
        //headerdetails.put(VoucherConstant.DESCRIPTION, CollectionConstants.FINANCIAL_VOUCHERDESCRIPTION);
<span class="nc" id="L822">        headerdetails.put(VoucherConstant.DESCRIPTION, narration);</span>
<span class="nc" id="L823">        headerdetails.put(VoucherConstant.VOUCHERDATE, voucherDate);</span>
<span class="nc" id="L824">        headerdetails.put(VoucherConstant.FUNDCODE, fundCode);</span>
<span class="nc" id="L825">        headerdetails.put(VoucherConstant.DEPARTMENTCODE, deptIdnew);</span>
<span class="nc" id="L826">        headerdetails.put(VoucherConstant.FUNCTIONCODE, functionCode);</span>
        //headerdetails.put(VoucherConstant.SUBDIVISON, subdivisonNew);
<span class="nc" id="L828">        return headerdetails;</span>
    }

    public List&lt;RemittanceDetail&gt; getRemittanceDetailsList(final BigDecimal creditAmount, final BigDecimal debitAmount,
            final String glCode, final Remittance remittance) {
<span class="nc" id="L833">        final List&lt;RemittanceDetail&gt; remittanceDetailsList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L834">        final RemittanceDetail remittanceDetail = new RemittanceDetail();</span>
<span class="nc" id="L835">        remittanceDetail.setCreditAmount(creditAmount);</span>
<span class="nc" id="L836">        remittanceDetail.setDebitAmount(debitAmount);</span>
<span class="nc" id="L837">        remittanceDetail.setRemittance(remittance);</span>
<span class="nc" id="L838">        remittanceDetail.setChartOfAccount(chartOfAccountsDAO.getCChartOfAccountsByGlCode(glCode));</span>
<span class="nc" id="L839">        remittanceDetailsList.add(remittanceDetail);</span>
<span class="nc" id="L840">        return remittanceDetailsList;</span>
    }
    
    public List&lt;RemittanceDetail&gt; getRemittanceDetailsListNew(final BigDecimal creditAmount, final BigDecimal debitAmount,
            final Map&lt;String, BigDecimal&gt; serviceGlCodes, final Remittance remittance) {
<span class="nc" id="L845">        final List&lt;RemittanceDetail&gt; remittanceDetailsList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L846">        Set&lt;String&gt; keys=serviceGlCodes.keySet();</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">        for(String key : keys)</span>
        {
<span class="nc" id="L849">	        final RemittanceDetail remittanceDetail = new RemittanceDetail();</span>
<span class="nc" id="L850">	        remittanceDetail.setCreditAmount(creditAmount);</span>
<span class="nc" id="L851">	        remittanceDetail.setDebitAmount(debitAmount);</span>
<span class="nc" id="L852">	        remittanceDetail.setRemittance(remittance);</span>
<span class="nc" id="L853">	        remittanceDetail.setChartOfAccount(chartOfAccountsDAO.getCChartOfAccountsByGlCode(serviceGlCodes.get(key).toString()));</span>
<span class="nc" id="L854">	        remittanceDetailsList.add(remittanceDetail);</span>
<span class="nc" id="L855">        }</span>
<span class="nc" id="L856">        return remittanceDetailsList;</span>
    }

    /**
     * Method to find all the Cash instruments with status as :new and
     *
     * @return List of HashMap
     */
	/*
	 * @Override public List&lt;ReceiptBean&gt;
	 * findCashRemittanceDetailsForServiceAndFund(final String boundaryIdList, final
	 * String serviceCodes, final String fundCodes, final Date startDate, final Date
	 * endDate, String serviceTypeId) { // TODO : need to make this call to mdms //
	 * FinancialStatus status =
	 * microserviceUtils.getInstrumentStatusByCode(CollectionConstants.
	 * INSTRUMENT_NEW_STATUS); List&lt;Instrument&gt; instruments =
	 * microserviceUtils.getInstruments(CollectionConstants.
	 * INSTRUMENTTYPE_NAME_CASH, TransactionType.Debit,
	 * CollectionConstants.INSTRUMENT_NEW_STATUS); List&lt;String&gt; receiptIds = new
	 * ArrayList&lt;&gt;(); for (Instrument i : instruments) {
	 * 
	 * //added for debug Instrument
	 * if(i.getInstrumentType().getName()==&quot;Cash&quot;||i.getInstrumentType().getName()==
	 * &quot;CASH&quot;) {
	 * System.out.println(&quot;INstrument Type Description&gt;&gt;&gt;&gt;&quot;+i.getInstrumentType().
	 * getDescription());
	 * System.out.println(&quot;INstrument Type Name&gt;&gt;&gt;&gt;&quot;+i.getInstrumentType().getName()
	 * ); }
	 * 
	 * if (i.getInstrumentVouchers() != null) for (InstrumentVoucher iv :
	 * i.getInstrumentVouchers()) { receiptIds.add(iv.getReceiptHeaderId()); } }
	 * List&lt;ReceiptBean&gt; resultList = new ArrayList&lt;&gt;(); if(!receiptIds.isEmpty()){
	 * List&lt;Receipt&gt; receipts = Collections.EMPTY_LIST; switch
	 * (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) { case &quot;V2&quot;:
	 * case &quot;VERSION2&quot;: receipts =
	 * microserviceUtils.getReceipts(StringUtils.join(receiptIds, &quot;,&quot;),
	 * PaymentStatusEnum.NEW.name(), serviceCodes,startDate, endDate,
	 * serviceTypeId); break;
	 * 
	 * default: receipts =
	 * microserviceUtils.getReceipts(StringUtils.join(receiptIds, &quot;,&quot;),
	 * CollectionConstants.RECEIPT_STATUS_APPROVED, serviceCodes,startDate,
	 * endDate,serviceTypeId); break; } Map&lt;String, List&lt;Receipt&gt;&gt;
	 * receiptDateWiseMap = new HashMap&lt;&gt;(); Map&lt;String, List&lt;Receipt&gt;&gt;
	 * serviceWiseMap = new HashMap&lt;&gt;(); Map&lt;String, List&lt;Receipt&gt;&gt;
	 * instrumentWiseMap = new HashMap&lt;&gt;(); Map&lt;String, List&lt;Receipt&gt;&gt; fundWiseMap =
	 * new HashMap&lt;&gt;(); Map&lt;String, List&lt;Receipt&gt;&gt; departmentWiseMap = new
	 * HashMap&lt;&gt;();
	 * 
	 * groupByReceiptDate(receiptDateWiseMap, receipts);
	 * 
	 * for (String key : receiptDateWiseMap.keySet()) { List&lt;Receipt&gt; tempList =
	 * receiptDateWiseMap.get(key); groupByService(key, serviceWiseMap, tempList); }
	 * 
	 * for (String key : serviceWiseMap.keySet()) { List&lt;Receipt&gt; tempList =
	 * serviceWiseMap.get(key); groupByInstrument(key, instrumentWiseMap, tempList);
	 * }
	 * 
	 * for (String key : instrumentWiseMap.keySet()) { List&lt;Receipt&gt; tempList =
	 * instrumentWiseMap.get(key); groupByFund(key, fundWiseMap, tempList); }
	 * 
	 * for (String key : fundWiseMap.keySet()) { List&lt;Receipt&gt; tempList =
	 * fundWiseMap.get(key); groupByDepartment(key, departmentWiseMap, tempList); }
	 * 
	 * for (String key : departmentWiseMap.keySet()) { List&lt;Receipt&gt; tempList =
	 * departmentWiseMap.get(key); populateResultList(key, resultList, tempList); }
	 * 
	 * populateNames(resultList); } return resultList; }
	 */
    
    @Override
    public List&lt;ReceiptBean&gt; findCashRemittanceDetailsForServiceAndFund(String classification, Date fromDate, Date toDate, String businessCode,
            String receiptNo,String type) {
<span class="nc" id="L929">    	List&lt;ReceiptBean&gt; resultList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L930">    	   List&lt;ReceiptHeader&gt; receiptList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L931">    	 List&lt;Receipt&gt; receipts  = microserviceUtils.searchRecieptsFin(classification, fromDate, toDate, businessCode, null, type);</span>
<span class="nc" id="L932">    	 System.out.println(&quot;Inside METHOD  after &gt;&gt;&quot;+receipts);</span>
<span class="nc" id="L933">    	int i=1;</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">    	 for (Receipt receipt : receipts) {</span>

<span class="nc bnc" id="L936" title="All 2 branches missed.">             for (org.egov.infra.microservice.models.Bill bill : receipt.getBill()) {</span>

<span class="nc bnc" id="L938" title="All 2 branches missed.">                 for (BillDetail billDetail : bill.getBillDetails()) {</span>
<span class="nc" id="L939">                	 ReceiptBean receiptHeader = new ReceiptBean();</span>
       
<span class="nc" id="L941">                	 receiptHeader.setInstrumentId(receipt.getInstrument().getInstrumentType().getId());</span>
<span class="nc" id="L942">                 	 receiptHeader.setInstrumentAmount(billDetail.getTotalAmount());</span>
<span class="nc" id="L943">                     receiptHeader.setInstrumentNumber(receipt.getInstrument().getInstrumentNumber());</span>
<span class="nc" id="L944">                     receiptHeader.setInstrumentType(receipt.getInstrument().getInstrumentType().getName());</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">                      if(receipt.getInstrument().getTransactionDate() !=null)</span>
<span class="nc" id="L946">                    	  receiptHeader.setInstrumentDate(DateUtils.toDefaultDateFormat(receipt.getInstrument().getTransactionDate()));</span>
                            
<span class="nc" id="L948">                      receiptHeader.setBankBranch(receipt.getInstrument().getBranchName());</span>
<span class="nc" id="L949">                     org.egov.infra.microservice.models.Bank bank = receipt.getInstrument().getBank();</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                     receiptHeader.setBank(bank != null ? bank.getName() : &quot;&quot;);</span>
<span class="nc" id="L951">                     receiptHeader.setReceiptId(receipt.getReceiptNumber());	</span>
<span class="nc" id="L952">                     receiptHeader.setReceiptNumber(receipt.getReceiptNumber());</span>
                     
<span class="nc" id="L954">                     receiptHeader.setReceiptId(receipt.getPaymentId());</span>
<span class="nc" id="L955">                     receiptHeader.setReceiptNumber(billDetail.getReceiptNumber());</span>
<span class="nc" id="L956">                    String receiptDate = DateUtils</span>
<span class="nc" id="L957">                             .toDefaultDateFormat(new Date(receipt.getBill().get(0).getBillDetails().get(0).getReceiptDate()));</span>
<span class="nc" id="L958">                    receiptHeader.setReceiptDate(receiptDate);</span>

<span class="nc" id="L960">                    receiptHeader.setService(billDetail.getBusinessService());</span>
<span class="nc" id="L961">                    receiptHeader.setRemittanceReferenceNumber(billDetail.getBillNumber());</span>
                    //receiptHeader.setFund(billDetail.getFund());
<span class="nc bnc" id="L963" title="All 2 branches missed.">                    receiptHeader.setFund(billDetail.getFund()!=null ? billDetail.getFund() :&quot;Municipal (General) Fund&quot;);//abhishek</span>
<span class="nc" id="L964">                    receiptHeader.setDepartment(billDetail.getDepartment());</span>

<span class="nc" id="L966">                     JsonNode jsonNode = billDetail.getAdditionalDetails();</span>
<span class="nc" id="L967">                     BillDetailAdditional additional = null;</span>
//                     try {
//                         if (null != jsonNode)
//                             additional = (BillDetailAdditional) new ObjectMapper().readValue(jsonNode.toString(),
//                                     BillDetailAdditional.class);
//                     } catch (Exception e) {
//                         e.printStackTrace();
//                     }
<span class="nc bnc" id="L975" title="All 2 branches missed.">                     if((receipt.getInstrument().getInstrumentType().getName())==&quot;CASH&quot;) {</span>
<span class="nc" id="L976">                     resultList.add(receiptHeader);</span>
        }
                     

<span class="nc" id="L980">                 }</span>
<span class="nc" id="L981">        }</span>

<span class="nc" id="L983">        }</span>
//////////////////////////////abhishek
<span class="nc" id="L985">    	 Map&lt;String, List&lt;Receipt&gt;&gt; receiptDateWiseMap = new HashMap&lt;&gt;();	</span>
<span class="nc" id="L986">         Map&lt;String, List&lt;Receipt&gt;&gt; serviceWiseMap = new HashMap&lt;&gt;();	</span>
<span class="nc" id="L987">         Map&lt;String, List&lt;Receipt&gt;&gt; instrumentWiseMap = new HashMap&lt;&gt;();	</span>
<span class="nc" id="L988">         Map&lt;String, List&lt;Receipt&gt;&gt; fundWiseMap = new HashMap&lt;&gt;();	</span>
<span class="nc" id="L989">         Map&lt;String, List&lt;Receipt&gt;&gt; departmentWiseMap = new HashMap&lt;&gt;();	</span>
<span class="nc" id="L990">         LOGGER.info(&quot;after request response processing&quot;);	</span>
<span class="nc" id="L991">         groupByReceiptDate(receiptDateWiseMap, receipts);	</span>
<span class="nc" id="L992">         LOGGER.info(&quot;after group by receipt&quot;);	</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">         for (String key : receiptDateWiseMap.keySet()) {	</span>
<span class="nc" id="L994">             List&lt;Receipt&gt; tempList = receiptDateWiseMap.get(key);	</span>
<span class="nc" id="L995">             groupByService(key, serviceWiseMap, tempList);	</span>
<span class="nc" id="L996">         }	</span>
<span class="nc" id="L997">         LOGGER.info(&quot;after group by service&quot;);	</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">         for (String key : serviceWiseMap.keySet()) {	</span>
<span class="nc" id="L999">             List&lt;Receipt&gt; tempList = serviceWiseMap.get(key);	</span>
<span class="nc" id="L1000">             groupByInstrument(key, instrumentWiseMap, tempList);	</span>
<span class="nc" id="L1001">         }	</span>
<span class="nc" id="L1002">         LOGGER.info(&quot;after group by instrument&quot;);	</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">         for (String key : instrumentWiseMap.keySet()) {	</span>
<span class="nc" id="L1004">             List&lt;Receipt&gt; tempList = instrumentWiseMap.get(key);	</span>
<span class="nc" id="L1005">             groupByFund(key, fundWiseMap, tempList);	</span>
<span class="nc" id="L1006">         }	</span>
<span class="nc" id="L1007">         LOGGER.info(&quot;after group by fund&quot;);	</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">         for (String key : fundWiseMap.keySet()) {	</span>
<span class="nc" id="L1009">             List&lt;Receipt&gt; tempList = fundWiseMap.get(key);	</span>
<span class="nc" id="L1010">             groupByDepartment(key, departmentWiseMap, tempList);	</span>
<span class="nc" id="L1011">         }	</span>
<span class="nc" id="L1012">         LOGGER.info(&quot;after group by dept&quot;);	</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">         for (String key : departmentWiseMap.keySet()) {	</span>
<span class="nc" id="L1014">             List&lt;Receipt&gt; tempList = departmentWiseMap.get(key);	</span>
<span class="nc" id="L1015">             populateResultList(key, resultList, tempList);	</span>
<span class="nc" id="L1016">         }	</span>
<span class="nc" id="L1017">         LOGGER.info(&quot;after group by resultlist&quot;);	</span>
<span class="nc" id="L1018">         populateNames(resultList);	</span>
<span class="nc" id="L1019">         LOGGER.info(&quot;after group by populateNames&quot;);	</span>
         
/////////////////////    	 

       // if(!receiptIds.isEmpty()){
        	
			/*
			 * List&lt;Receipt&gt; receipts = Collections.EMPTY_LIST; switch
			 * (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) { case &quot;V2&quot;:
			 * case &quot;VERSION2&quot;: receipts =
			 * microserviceUtils.getReceipts(StringUtils.join(receiptIds, &quot;,&quot;),
			 * PaymentStatusEnum.NEW.name(), serviceCodes,startDate, endDate,
			 * serviceTypeId); break;
			 * 
			 * default: receipts =
			 * microserviceUtils.getReceipts(StringUtils.join(receiptIds, &quot;,&quot;),
			 * CollectionConstants.RECEIPT_STATUS_APPROVED, serviceCodes,startDate,
			 * endDate,serviceTypeId); break; }
			 */
         
<span class="nc" id="L1039">        return resultList;</span>
    }
    
    public List&lt;ReceiptBean&gt; findCashRemittanceDetailsForServiceAndFund(String classification, Date fromDate, Date toDate, String businessCode,
            String receiptNo,String department,String type, String searchAmount, String subDivision,String collectedBy) {
<span class="nc" id="L1044">    	List&lt;ReceiptBean&gt; resultList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1045">    	List&lt;ReceiptHeader&gt; receiptList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1046">    	boolean amountcheck=false;</span>
<span class="nc" id="L1047">    	boolean deptcheck=false;</span>
<span class="nc" id="L1048">    	boolean subdivisioncheck=false; </span>
<span class="nc" id="L1049">    	boolean receiptcheck=false;</span>
<span class="nc" id="L1050">    	boolean collectedcheck=false;</span>
<span class="nc" id="L1051">    	final StringBuffer query1 = new StringBuffer(500);</span>
<span class="nc" id="L1052">		List&lt;Object[]&gt; list1= null;</span>
<span class="nc" id="L1053">    	SQLQuery queryMain =  null;</span>
<span class="nc" id="L1054">    	query1</span>
<span class="nc" id="L1055">        .append(&quot;select v2.reciept_number, v2.departmentcode, fnc.code as fnccode from vouchermis v2,\&quot;function\&quot; fnc where v2.reciept_number notnull and fnc.id  = v2.functionid&quot;);</span>
<span class="nc" id="L1056">    	queryMain=this.persistenceService.getSession().createSQLQuery(query1.toString());</span>
<span class="nc" id="L1057">    	list1 = queryMain.list();</span>
<span class="nc" id="L1058">    	System.out.println(&quot;:::list size::::: &quot;+list1.size());	</span>
<span class="nc" id="L1059">    	Map&lt;String, String&gt; deptMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1060">    	Map&lt;String,String&gt; funMap=new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">    	if(list1!=null)</span>
    	{
<span class="nc bnc" id="L1063" title="All 2 branches missed.">    		for (final Object[] object : list1)</span>
    		{
<span class="nc" id="L1065">    			deptMap.put(object[0].toString(), object[1].toString());</span>
<span class="nc" id="L1066">    			funMap.put(object[0].toString(), object[2].toString());</span>
<span class="nc" id="L1067">    		}</span>
    	}
    	
<span class="nc" id="L1070">    	 List&lt;Receipt&gt; receipts  = null;//microserviceUtils.searchRecieptsFinNew(classification, fromDate, toDate, businessCode, null, type);</span>
<span class="nc" id="L1071">    	 System.out.println(&quot;Inside METHOD  after &gt;&gt;&quot;+receipts);</span>
<span class="nc" id="L1072">    	 int i=1;</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">    	 for (Receipt receipt : receipts) {</span>
/*
	  
             for (org.egov.infra.microservice.models.Bill bill : receipt.getBill()) {

                 for (BillDetail billDetail : bill.getBillDetails()) {
                	 ReceiptBean receiptBean = new ReceiptBean();
       
                	 receiptBean.setInstrumentId(receipt.getInstrument().getInstrumentType().getId());
                 	 receiptBean.setInstrumentAmount(billDetail.getTotalAmount());
                     receiptBean.setInstrumentNumber(receipt.getInstrument().getInstrumentNumber());
                     receiptBean.setInstrumentType(receipt.getInstrument().getInstrumentType().getName());
                      if(receipt.getInstrument().getTransactionDate() !=null)
                    	  receiptBean.setInstrumentDate(DateUtils.toDefaultDateFormat(receipt.getInstrument().getTransactionDate()));
                            
	  
                      receiptBean.setBankBranch(receipt.getInstrument().getBranchName());
                     org.egov.infra.microservice.models.Bank bank = receipt.getInstrument().getBank();
                     receiptBean.setBank(bank != null ? bank.getName() : &quot;&quot;);
                     //receiptBean.setReceiptId(receipt.getReceiptNumber());	
                     receiptBean.setReceiptNumber(receipt.getReceiptNumber());
                     if(funMap.containsKey(receipt.getReceiptNumber()))
                     {
                    	 receiptBean.setFunctionCode(funMap.get(receipt.getReceiptNumber()));
                     }
                     else {
                    	 receiptBean.setFunctionCode(null);
                     }
                     receiptBean.setReceiptId(receipt.getPaymentId());
                     //receiptBean.setReceiptNumber(billDetail.getReceiptNumber());
                    String receiptDate = DateUtils
                             .toDefaultDateFormat(new Date(receipt.getBill().get(0).getBillDetails().get(0).getReceiptDate()));
																			   
                    receiptBean.setReceiptDate(receiptDate);
                    receiptBean.setService(microserviceUtils.getBusinessServiceNameByCode(billDetail.getBusinessService()));
										
                    receiptBean.setRemittanceReferenceNumber(billDetail.getBillNumber());
                    //receiptBean.setFund(billDetail.getFund());
                    receiptBean.setFund(billDetail.getFund()!=null ? billDetail.getFund() :&quot;Municipal (General) Fund&quot;);//abhishek
											 
                    if(deptMap.containsKey(receipt.getReceiptNumber()))
	    			{
                    	receiptBean.setDepartment(deptMap.get(receipt.getReceiptNumber()));
	    			}
                    else {
                    	receiptBean.setDepartment(billDetail.getDepartment());
                    }
                    System.out.println(&quot;dept &quot;+receiptBean.getDepartment());
                    receiptBean.setSubDivision(receipt.getSubdivison());
                    receiptBean.setCreatedUser(receipt.getCollectedByName());
                     JsonNode jsonNode = billDetail.getAdditionalDetails();
                     BillDetailAdditional additional = null;
                     
                     BigDecimal searchamt = new BigDecimal(0);
	                 	if(searchAmount!=null &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;&quot;) &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;0&quot;)) {
	                 		searchamt=new BigDecimal(Integer.parseInt(searchAmount));
	                 		amountcheck=true;
	                 	}
	                 	if(!subDivision.equalsIgnoreCase(&quot;-1&quot;))
	                 	{
	                 		subdivisioncheck=true;
	                 	}
	                 	if(!department.equalsIgnoreCase(&quot;-1&quot;))
	                 	{
	                 		deptcheck=true;
	                 	}
	                 	if(receiptNo!=null &amp;&amp; !receiptNo.equalsIgnoreCase(&quot;&quot;)) {
	                		receiptcheck=true;
	                	}
	                 	if(collectedBy!=null &amp;&amp; !collectedBy.equalsIgnoreCase(&quot;&quot;)) {
	                		collectedcheck=true;
	                	}
                    if((receipt.getInstrument().getInstrumentType().getName()).equalsIgnoreCase(&quot;CASH&quot;)&amp;&amp;
                    		receipt.getPaymentStatus().equalsIgnoreCase(&quot;NEW&quot;)) 
                    {	
                    	if(amountcheck)
                    	{
                    		if(searchamt.compareTo(receipt.getInstrument().getAmount())==0) {}
                    		else
                    			continue;
                    	}
                    	if(subdivisioncheck)
                    	{
                    		if(subDivision.equalsIgnoreCase(receipt.getSubdivison())) {}
                    		else
                    			continue;
                    	}
                    	 if(deptcheck)
                    	{
                    		if(department.equalsIgnoreCase(receiptBean.getDepartment())) {}
                    		else
                    			continue;
                    	}
                    	if(receiptcheck)
                    	{
                    		if(receiptNo.equalsIgnoreCase(receipt.getReceiptNumber())) {}
                    		else
                    			continue;
                    	}
                    	if(collectedcheck)
                    	{
                    		if(collectedBy.equalsIgnoreCase(receiptBean.getCreatedUser())) {}
                    		else
                    			continue;
                    	}
                    	resultList.add(receiptBean);
                    }
                 }
             }
        }*/
<span class="nc" id="L1183">    	 populateNamesForCash(resultList);</span>
<span class="nc" id="L1184">    	 }</span>
<span class="nc" id="L1185">        return resultList;</span>
    }
    
    public List&lt;ReceiptBean&gt; findCashRemittanceDetailsForServiceAndFundNew(String classification, Date fromDate, Date toDate, String businessCode,
            String receiptNo,String department,String type, String searchAmount, String subDivision,String collectedBy,String mType) {
<span class="nc" id="L1190">    	this.getServiceCategoryList();</span>
<span class="nc" id="L1191">    	boolean deptcheck=false;</span>
<span class="nc" id="L1192">    	List&lt;ReceiptBean&gt; resultList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1193">    	List&lt;Object[]&gt; result= new ArrayList();</span>
<span class="nc" id="L1194">    	List&lt;Object[]&gt; misresult= new ArrayList();</span>
<span class="nc" id="L1195">    	SQLQuery misquery=null;</span>
<span class="nc" id="L1196">    	StringBuffer query1=new StringBuffer(&quot;select v2.reciept_number,fnc.code,v2.departmentcode,ed.\&quot;name\&quot; as departmentname from eg_department ed,\&quot;function\&quot; fnc,vouchermis v2 where v2.reciept_number notnull and fnc.id =v2.functionid and ed.code =v2.departmentcode&quot;);</span>
<span class="nc" id="L1197">    	misquery=this.persistenceService.getSession().createSQLQuery(query1.toString());</span>
<span class="nc" id="L1198">    	misresult = misquery.list();</span>
<span class="nc" id="L1199">	    	System.out.println(&quot;:::misresult size::::: &quot;+misresult.size());</span>
<span class="nc" id="L1200">	    	Map&lt;String, String&gt; deptMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1201">	    	Map&lt;String,String&gt; funcMap=new HashMap&lt;&gt;();</span>
<span class="nc" id="L1202">	    	Map&lt;String, String&gt; deptNameMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">	    	if(misresult!=null)</span>
	    	{
<span class="nc bnc" id="L1205" title="All 2 branches missed.">	    		for (final Object[] object : misresult)</span>
	    		{
<span class="nc" id="L1207">	    			funcMap.put(object[0].toString(), object[1].toString());</span>
<span class="nc" id="L1208">	    			deptMap.put(object[0].toString(), object[2].toString());</span>
<span class="nc" id="L1209">	    			deptNameMap.put(object[0].toString(), object[3].toString());</span>
<span class="nc" id="L1210">	    		}</span>
	    	}
	    	
<span class="nc" id="L1213">    	SQLQuery searchQuery =  null;</span>
<span class="nc" id="L1214">    	StringBuffer query = new StringBuffer(&quot;select distinct mrd.payments_id, &quot; + </span>
    			&quot; mrd.receipt_number, to_char(mrd.receipt_date,'dd/mm/yyyy'), mrd.subdivison, mrd.servicename, &quot; + 
    			&quot; mrd.collectedbyname,&quot; + 
    			&quot; ('01') as fundcode, ('Municipal (General) Fund') as fundname, &quot;+ 
    			&quot; mrd.total_amt_paid,mrd.payment_mode,mrd.id  from mis_receipts_details mrd &quot;+
  				&quot; where mrd.payment_status = 'NEW'&quot;);
    	
<span class="nc" id="L1221">     		 BigDecimal searchamt = new BigDecimal(0);</span>
<span class="nc" id="L1222">			query.append(getDateQuery(fromDate, toDate));									</span>
<span class="nc bnc" id="L1223" title="All 6 branches missed.">           	if(searchAmount!=null &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;&quot;) &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;0&quot;)) {</span>
<span class="nc" id="L1224">           		searchamt=new BigDecimal(Integer.parseInt(searchAmount));</span>
<span class="nc" id="L1225">           		query.append(&quot; and mrd.total_amt_paid = &quot;+ searchamt);</span>
           	}
<span class="nc bnc" id="L1227" title="All 2 branches missed.">           	if(!subDivision.equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L1228">           		query.append(&quot; and mrd.subdivison = '&quot;+ subDivision+&quot;'&quot;);</span>
           	}		
<span class="nc bnc" id="L1230" title="All 4 branches missed.">           	if (null != receiptNo &amp;&amp; !receiptNo.equalsIgnoreCase(&quot;&quot;)) {</span>
<span class="nc" id="L1231">           		query.append(&quot; and mrd.receipt_number = '&quot;+ receiptNo+&quot;'&quot;);</span>
           	}		
<span class="nc bnc" id="L1233" title="All 4 branches missed.">           	if(collectedBy!=null &amp;&amp; !collectedBy.equalsIgnoreCase(&quot;&quot;)) {</span>
<span class="nc" id="L1234">           		query.append(&quot; and lower(mrd.collectedbyname) like ('%&quot;+ collectedBy.toLowerCase()+&quot;%')&quot;);</span>
           	}	 	
<span class="nc bnc" id="L1236" title="All 4 branches missed.">           	if(businessCode!=null &amp;&amp; !businessCode.equalsIgnoreCase(&quot;-1&quot;)) {</span>
<span class="nc" id="L1237">           		query.append(&quot; and mrd.servicename = '&quot; + businessCode+&quot;'&quot;);</span>
				}
<span class="nc bnc" id="L1239" title="All 2 branches missed.">           	if(mType.equalsIgnoreCase(&quot;Cash&quot;))</span>
           	{
<span class="nc" id="L1241">           		query.append(&quot; and mrd.payment_mode = 'CASH' &quot;);</span>
           	}
           	else
           	{
<span class="nc" id="L1245">           		query.append(&quot; and mrd.payment_mode in ('CHEQUE','DD') &quot;);														   </span>
           	}
     	 
<span class="nc" id="L1248"> 	    	System.out.println(&quot;Search Query &quot;+query);</span>
 	    	try {
<span class="nc" id="L1250"> 	    	searchQuery=this.persistenceService.getSession().createSQLQuery(query.toString());</span>
<span class="nc" id="L1251"> 	    	result = searchQuery.list();</span>
<span class="nc" id="L1252"> 	    	System.out.println(&quot;:::list size::::: &quot;+result.size());	</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed."> 	    	if(!department.equalsIgnoreCase(&quot;-1&quot;))</span>
         	{
<span class="nc" id="L1255">         		deptcheck=true;</span>
         	}
<span class="nc bnc" id="L1257" title="All 2 branches missed."> 	    	if(result!=null)</span>
 	    	{
<span class="nc" id="L1259"> 	    		int i=1;</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed."> 	    		for (final Object[] object : result)</span>
 	    		{
<span class="nc" id="L1262"> 	    			ReceiptBean receiptBean = new ReceiptBean();</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed."> 	    			receiptBean.setReceiptId((object[10]!=null)?object[10].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed."> 	    			receiptBean.setReceiptNumber((object[1]!=null)?object[1].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed."> 	    		 	receiptBean.setReceiptDate((object[2]!=null)?object[2].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed."> 	    		 	receiptBean.setSubDivision((object[3]!=null)?object[3].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed."> 	    		 	if(object[4]!= null) {</span>
<span class="nc" id="L1268"> 						String s3 = null;</span>
<span class="nc" id="L1269"> 						String s4 = null;</span>
<span class="nc" id="L1270"> 						String s1 = null;</span>
<span class="nc" id="L1271"> 						String s2 = null;</span>
<span class="nc" id="L1272"> 						String service=null;</span>
<span class="nc" id="L1273"> 						String[] split = object[4].toString().split(Pattern.quote(&quot;.&quot;));</span>
<span class="nc" id="L1274"> 						s1 = split[0];</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed."> 						if (split.length == 2) {</span>
<span class="nc" id="L1276"> 							s2 = split[1];</span>
 						}
<span class="nc bnc" id="L1278" title="All 2 branches missed."> 						if (serviceCategoryNames.containsKey(s1)) {</span>
<span class="nc" id="L1279"> 							s3 = serviceCategoryNames.get(s1);</span>
 						}
<span class="nc bnc" id="L1281" title="All 2 branches missed."> 						if (serviceCategoryNames.containsKey(s2)) {</span>
<span class="nc" id="L1282"> 							s4 = serviceCategoryNames.get(s2);</span>
 						} 						
<span class="nc bnc" id="L1284" title="All 2 branches missed."> 						if (s4 != null) {</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed."> 							if (s3 != null) {</span>
<span class="nc" id="L1286"> 								service = s3 + &quot;.&quot; + s4;</span>
 							} else {
<span class="nc" id="L1288"> 								service = s4;</span>
 							}
 						} else {
<span class="nc" id="L1291"> 							service = s3;</span>
 						}
<span class="nc bnc" id="L1293" title="All 2 branches missed."> 						receiptBean.setServiceName((service!=null)?service:&quot;&quot;);</span>
 					}
 	    		 	
<span class="nc bnc" id="L1296" title="All 2 branches missed."> 	    		 	receiptBean.setService((object[4]!=null)?object[4].toString():&quot;-1&quot;);</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed."> 	    		 	receiptBean.setCreatedUser((object[5]!=null)?object[5].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed."> 	    		 	if(object[1]!=null)</span>
 	    		 	{
<span class="nc bnc" id="L1300" title="All 2 branches missed."> 	    		 		if(deptMap.containsKey(object[1].toString())){</span>
<span class="nc" id="L1301"> 	    		 			LOGGER.info(&quot;departmentCode &quot;+deptMap.get(object[1].toString()));</span>
<span class="nc" id="L1302"> 	    		 			receiptBean.setDepartment(deptMap.get(object[1].toString()));</span>
 	    		 		}
 	    		 	}
 	    		 	else {
<span class="nc" id="L1306"> 	    		 		receiptBean.setDepartment(&quot;&quot;);</span>
 	    		 	}
<span class="nc bnc" id="L1308" title="All 2 branches missed."> 	    		 	if(object[1]!=null)</span>
 	    		 	{
<span class="nc bnc" id="L1310" title="All 2 branches missed."> 	    		 		if(deptNameMap.containsKey(object[1].toString())){</span>
<span class="nc" id="L1311"> 	    		 			LOGGER.info(&quot;departmentName &quot;+deptNameMap.get(object[1].toString()));</span>
<span class="nc" id="L1312"> 	    		 			receiptBean.setDepartmentName(deptNameMap.get(object[1].toString()));</span>
 	    		 		}
 	    		 	}
 	    		 	else {
<span class="nc" id="L1316"> 	    		 		receiptBean.setDepartmentName(&quot;&quot;);</span>
 	    		 	}
<span class="nc bnc" id="L1318" title="All 2 branches missed."> 	    		 	if(object[1]!=null)</span>
 	    		 	{
<span class="nc bnc" id="L1320" title="All 2 branches missed."> 	    		 		if(funcMap.containsKey(object[1].toString())){</span>
<span class="nc" id="L1321"> 	    		 			receiptBean.setFunctionCode(funcMap.get(object[1].toString()));</span>
 	    		 		}
 	    		 	}
 	    		 	else {
<span class="nc" id="L1325"> 	    		 		receiptBean.setFunctionCode(&quot;&quot;);</span>
 	    		 	}
<span class="nc bnc" id="L1327" title="All 2 branches missed."> 	    		 	receiptBean.setFund((object[6]!=null)?object[6].toString():&quot;-1&quot;);</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed."> 	    		 	receiptBean.setFundName((object[7]!=null)?object[7].toString():&quot;&quot;);</span>
 	    		 	//receiptBean.setRemittanceReferenceNumber((object[11]!=null)?object[11].toString():&quot;&quot;);
<span class="nc bnc" id="L1330" title="All 2 branches missed."> 	    			receiptBean.setInstrumentAmount((object[8]!=null)?(new BigDecimal(object[8].toString())):new BigDecimal(0));</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed."> 	    			receiptBean.setInstrumentType((object[9]!=null)?object[9].toString():&quot;&quot;);</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed."> 	    			if(deptcheck)</span>
                	{
<span class="nc bnc" id="L1334" title="All 2 branches missed.">                		if(department.equalsIgnoreCase(receiptBean.getDepartment())) {}</span>
                		else
                			continue;
                	}
<span class="nc" id="L1338"> 	    		 	resultList.add(receiptBean);</span>
<span class="nc" id="L1339"> 	    		}</span>
 	    	}
 	    	//populateNamesForCash(resultList);
    	}
<span class="nc" id="L1343">    	catch(Exception e)</span>
    	{
<span class="nc" id="L1345">    		e.printStackTrace();</span>
<span class="nc" id="L1346">    	}</span>
<span class="nc" id="L1347">        return resultList;</span>
    }

    private void populateNames(List&lt;ReceiptBean&gt; resultList) {
<span class="nc" id="L1351">        List&lt;Fund&gt; fundList = fundHibernateDAO.findAllActiveFunds();</span>
<span class="nc" id="L1352">        List&lt;Department&gt; departmentList = microserviceUtils.getDepartments();</span>
<span class="nc" id="L1353">        List&lt;BusinessService&gt; businessServiceList = microserviceUtils.getBusinessService(null);</span>
<span class="nc" id="L1354">        Map&lt;String, String&gt; fundCodeNameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1355">        Map&lt;String, String&gt; deptCodeNameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1356">        Map&lt;String, String&gt; businessDetailsCodeNameMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L1358" title="All 2 branches missed.">        if (fundList != null)</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">            for (Fund f : fundList) {</span>
<span class="nc" id="L1360">                fundCodeNameMap.put(f.getCode(), f.getName());</span>
<span class="nc" id="L1361">            }</span>

<span class="nc bnc" id="L1363" title="All 2 branches missed.">        if (departmentList != null)</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">            for (Department dept : departmentList) {</span>
<span class="nc" id="L1365">                deptCodeNameMap.put(dept.getCode(), dept.getName());</span>
<span class="nc" id="L1366">            }</span>

<span class="nc bnc" id="L1368" title="All 2 branches missed.">        if (businessServiceList != null)</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">            for (BusinessService bd : businessServiceList) {</span>
<span class="nc" id="L1370">                businessDetailsCodeNameMap.put(bd.getCode(), bd.getBusinessService());</span>
<span class="nc" id="L1371">            }</span>
<span class="nc" id="L1372">        Set&lt;String&gt; bsCodes = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        for(ReceiptBean rb : resultList){</span>
<span class="nc" id="L1374">            bsCodes.add(rb.getService());</span>
<span class="nc" id="L1375">        }</span>
<span class="nc" id="L1376">        BusinessServiceCriteria criteria = new BusinessServiceCriteria();</span>
<span class="nc" id="L1377">        criteria.setCode(StringUtils.join(bsCodes,','));</span>
<span class="nc" id="L1378">        criteria.setVoucherCreationEnabled(true);</span>
<span class="nc" id="L1379">        List&lt;BusinessServiceMapping&gt; businessServiceMappingList = microserviceUtils.getBusinessServiceMappingBySearchCriteria(criteria );</span>
<span class="nc" id="L1380">        Map&lt;String,BusinessServiceMapping&gt; bsServiceMapping = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1381">        businessServiceMappingList.stream().forEach(bsm -&gt; {</span>
<span class="nc" id="L1382">            bsServiceMapping.put(bsm.getCode(), bsm);</span>
<span class="nc" id="L1383">        });</span>

<span class="nc bnc" id="L1385" title="All 2 branches missed.">        for (ReceiptBean rb : resultList) {</span>
<span class="nc" id="L1386">            String serviceCode = rb.getService();</span>
<span class="nc bnc" id="L1387" title="All 4 branches missed.">            if (serviceCode != null &amp;&amp; !serviceCode.isEmpty()){</span>
<span class="nc" id="L1388">                rb.setServiceName(businessDetailsCodeNameMap.get(serviceCode));</span>
<span class="nc" id="L1389">                BusinessServiceMapping serviceMapping = bsServiceMapping.get(serviceCode);</span>
				
<span class="nc bnc" id="L1391" title="All 2 branches missed.">                if(StringUtils.isNoneBlank(serviceMapping.getDepartment())){</span>
<span class="nc" id="L1392">                    rb.setDepartmentName(deptCodeNameMap.get(serviceMapping.getDepartment()));</span>
					 
                }
            }
<span class="nc" id="L1396">        }</span>
<span class="nc" id="L1397">    }</span>
    
    private void populateNamesForCash(List&lt;ReceiptBean&gt; resultList) {
<span class="nc" id="L1400">        List&lt;Fund&gt; fundList = fundHibernateDAO.findAllActiveFunds();</span>
<span class="nc" id="L1401">        List&lt;Department&gt; departmentList = microserviceUtils.getDepartments();</span>
<span class="nc" id="L1402">        List&lt;BusinessService&gt; businessServiceList = microserviceUtils.getBusinessService(null);</span>
<span class="nc" id="L1403">        Map&lt;String, String&gt; fundCodeNameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1404">        Map&lt;String, String&gt; deptCodeNameMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1405">        Map&lt;String, String&gt; businessDetailsCodeNameMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L1407" title="All 2 branches missed.">        if (fundList != null)</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">            for (Fund f : fundList) {</span>
<span class="nc" id="L1409">                fundCodeNameMap.put(f.getCode(), f.getName());</span>
<span class="nc" id="L1410">            }</span>

<span class="nc bnc" id="L1412" title="All 2 branches missed.">        if (departmentList != null)</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">            for (Department dept : departmentList) {</span>
<span class="nc" id="L1414">                deptCodeNameMap.put(dept.getCode(), dept.getName());</span>
<span class="nc" id="L1415">            }</span>

<span class="nc bnc" id="L1417" title="All 2 branches missed.">        if (businessServiceList != null)</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            for (BusinessService bd : businessServiceList) {</span>
<span class="nc" id="L1419">                businessDetailsCodeNameMap.put(bd.getCode(), bd.getBusinessService());</span>
<span class="nc" id="L1420">            }</span>
<span class="nc" id="L1421">        Set&lt;String&gt; bsCodes = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        for(ReceiptBean rb : resultList){</span>
<span class="nc" id="L1423">            bsCodes.add(rb.getService());</span>
<span class="nc" id="L1424">        }</span>
<span class="nc" id="L1425">        BusinessServiceCriteria criteria = new BusinessServiceCriteria();</span>
<span class="nc" id="L1426">        criteria.setCode(StringUtils.join(bsCodes,','));</span>
<span class="nc" id="L1427">        criteria.setVoucherCreationEnabled(true);</span>
<span class="nc" id="L1428">        List&lt;BusinessServiceMapping&gt; businessServiceMappingList = microserviceUtils.getBusinessServiceMappingBySearchCriteria(criteria );</span>
<span class="nc" id="L1429">        Map&lt;String,BusinessServiceMapping&gt; bsServiceMapping = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1430">        businessServiceMappingList.stream().forEach(bsm -&gt; {</span>
<span class="nc" id="L1431">            bsServiceMapping.put(bsm.getCode(), bsm);</span>
<span class="nc" id="L1432">        });</span>

<span class="nc bnc" id="L1434" title="All 2 branches missed.">        for (ReceiptBean rb : resultList) {</span>
<span class="nc" id="L1435">            String serviceCode = rb.getService();</span>
<span class="nc bnc" id="L1436" title="All 4 branches missed.">            if (serviceCode != null &amp;&amp; !serviceCode.isEmpty()){</span>
<span class="nc" id="L1437">                rb.setServiceName(businessDetailsCodeNameMap.get(serviceCode));</span>
<span class="nc" id="L1438">                BusinessServiceMapping serviceMapping = bsServiceMapping.get(serviceCode);</span>
                
<span class="nc bnc" id="L1440" title="All 2 branches missed.">                if(StringUtils.isNoneBlank(rb.getDepartment())){</span>
<span class="nc" id="L1441">                    rb.setDepartmentName(deptCodeNameMap.get(rb.getDepartment()));</span>
                }
            }
<span class="nc" id="L1444">        }</span>
<span class="nc" id="L1445">    }</span>

    private void populateResultList(String key, List&lt;ReceiptBean&gt; result, List&lt;Receipt&gt; tempList) {
<span class="nc" id="L1448">        ReceiptBean receipt = new ReceiptBean();</span>
<span class="nc" id="L1449">        BigDecimal amount = BigDecimal.ZERO;</span>

<span class="nc bnc" id="L1451" title="All 2 branches missed.">        for (Receipt r : tempList) {</span>
<span class="nc" id="L1452">            amount = amount.add(r.getInstrument().getAmount());</span>
<span class="nc" id="L1453">        }</span>

<span class="nc" id="L1455">        receipt.setReceiptDate(key.split(&quot;-&quot;)[0]);</span>
<span class="nc" id="L1456">        receipt.setService(key.split(&quot;-&quot;)[1]);</span>
<span class="nc" id="L1457">        receipt.setInstrumentType(key.split(&quot;-&quot;)[2]);</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        if (key.split(&quot;-&quot;).length &gt; 3)</span>
<span class="nc" id="L1459">            receipt.setFund(key.split(&quot;-&quot;)[3]);</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">        if (key.split(&quot;-&quot;).length &gt; 4)</span>
<span class="nc" id="L1461">            receipt.setDepartment(key.split(&quot;-&quot;)[4]);</span>
<span class="nc" id="L1462">        receipt.setInstrumentAmount(amount);</span>
<span class="nc" id="L1463">        result.add(receipt);</span>
<span class="nc" id="L1464">    }</span>

    private void groupByDepartment(String key, Map&lt;String, List&lt;Receipt&gt;&gt; departmentWiseMap,
            List&lt;Receipt&gt; tempList) {
        String department;
<span class="nc bnc" id="L1469" title="All 2 branches missed.">        for (Receipt r : tempList) {</span>
<span class="nc" id="L1470">            department = r.getBill().get(0).getBillDetails().get(0).getDepartment();</span>
<span class="nc bnc" id="L1471" title="All 4 branches missed.">            if (department != null &amp;&amp; !department.isEmpty()) {</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">                if (!departmentWiseMap.containsKey(key + &quot;-&quot; + department)) {</span>
<span class="nc" id="L1473">                    List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1474">                    list.add(r);</span>
<span class="nc" id="L1475">                    departmentWiseMap.put(key + &quot;-&quot; + department, list);</span>
<span class="nc" id="L1476">                } else {</span>
<span class="nc" id="L1477">                    departmentWiseMap.get(key + &quot;-&quot; + department).add(r);</span>
                }
            } else {
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                if (!departmentWiseMap.containsKey(key)) {</span>
<span class="nc" id="L1481">                    List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1482">                    list.add(r);</span>
<span class="nc" id="L1483">                    departmentWiseMap.put(key, list);</span>
<span class="nc" id="L1484">                } else {</span>
<span class="nc" id="L1485">                    departmentWiseMap.get(key).add(r);</span>
                }
            }
<span class="nc" id="L1488">        }</span>
<span class="nc" id="L1489">    }</span>

    private void groupByFund(String key, Map&lt;String, List&lt;Receipt&gt;&gt; fundWiseMap,
            List&lt;Receipt&gt; tempList) {
        String fund;
<span class="nc bnc" id="L1494" title="All 2 branches missed.">        for (Receipt r : tempList) {</span>
<span class="nc" id="L1495">            fund = r.getBill().get(0).getBillDetails().get(0).getFund();</span>
<span class="nc bnc" id="L1496" title="All 4 branches missed.">            if (fund != null &amp;&amp; !fund.isEmpty()) {</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">                if (!fundWiseMap.containsKey(key + &quot;-&quot; + fund)) {</span>
<span class="nc" id="L1498">                    List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1499">                    list.add(r);</span>
<span class="nc" id="L1500">                    fundWiseMap.put(key + &quot;-&quot; + fund, list);</span>
<span class="nc" id="L1501">                } else {</span>
<span class="nc" id="L1502">                    fundWiseMap.get(key + &quot;-&quot; + fund).add(r);</span>
                }
            } else {
<span class="nc bnc" id="L1505" title="All 2 branches missed.">                if (!fundWiseMap.containsKey(key)) {</span>
<span class="nc" id="L1506">                    List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1507">                    list.add(r);</span>
<span class="nc" id="L1508">                    fundWiseMap.put(key, list);</span>
<span class="nc" id="L1509">                } else {</span>
<span class="nc" id="L1510">                    fundWiseMap.get(key).add(r);</span>
                }
            }
<span class="nc" id="L1513">        }</span>
<span class="nc" id="L1514">    }</span>

    private void groupByInstrument(String receiptDateAndService, Map&lt;String, List&lt;Receipt&gt;&gt; instrumentWiseMap,
            List&lt;Receipt&gt; tempList) {
        String instrument;
<span class="nc bnc" id="L1519" title="All 2 branches missed.">        for (Receipt r : tempList) {</span>
<span class="nc" id="L1520">            instrument = r.getInstrument().getInstrumentType().getName();</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">            if (!instrumentWiseMap.containsKey(receiptDateAndService + &quot;-&quot; + instrument)) {</span>
<span class="nc" id="L1522">                List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1523">                list.add(r);</span>
<span class="nc" id="L1524">                instrumentWiseMap.put(receiptDateAndService + &quot;-&quot; + instrument, list);</span>
<span class="nc" id="L1525">            } else {</span>
<span class="nc" id="L1526">                instrumentWiseMap.get(receiptDateAndService + &quot;-&quot; + instrument).add(r);</span>
            }
<span class="nc" id="L1528">        }</span>
<span class="nc" id="L1529">    }</span>

    private void groupByService(String receiptDate, Map&lt;String, List&lt;Receipt&gt;&gt; serviceWiseMap, List&lt;Receipt&gt; tempList) {
        String service;
<span class="nc bnc" id="L1533" title="All 2 branches missed.">        for (Receipt r : tempList) {</span>
<span class="nc" id="L1534">            service = r.getBill().get(0).getBillDetails().get(0).getBusinessService();</span>
<span class="nc bnc" id="L1535" title="All 2 branches missed.">            if (!serviceWiseMap.containsKey(receiptDate + &quot;-&quot; + service)) {</span>
<span class="nc" id="L1536">                List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1537">                list.add(r);</span>
<span class="nc" id="L1538">                serviceWiseMap.put(receiptDate + &quot;-&quot; + service, list);</span>
<span class="nc" id="L1539">            } else {</span>
<span class="nc" id="L1540">                serviceWiseMap.get(receiptDate + &quot;-&quot; + service).add(r);</span>
            }
<span class="nc" id="L1542">        }</span>
<span class="nc" id="L1543">    }</span>

    private void groupByReceiptDate(Map&lt;String, List&lt;Receipt&gt;&gt; receiptDateWiseMap, List&lt;Receipt&gt; receipts) {
        String receiptDate;
<span class="nc bnc" id="L1547" title="All 2 branches missed.">        for (Receipt receipt : receipts) {</span>
<span class="nc" id="L1548">            receiptDate = DateUtils</span>
<span class="nc" id="L1549">                    .toDefaultDateFormat(new Date(receipt.getBill().get(0).getBillDetails().get(0).getReceiptDate()));</span>
<span class="nc bnc" id="L1550" title="All 2 branches missed.">            if (!receiptDateWiseMap.containsKey(receiptDate)) {</span>
<span class="nc" id="L1551">                List&lt;Receipt&gt; list = new ArrayList&lt;Receipt&gt;();</span>
<span class="nc" id="L1552">                list.add(receipt);</span>

<span class="nc" id="L1554">                receiptDateWiseMap.put(receiptDate, list);</span>
<span class="nc" id="L1555">            } else {</span>
<span class="nc" id="L1556">                receiptDateWiseMap.get(receiptDate).add(receipt);</span>
            }

<span class="nc" id="L1559">        }</span>

<span class="nc" id="L1561">    }</span>

    /**
     * Method to find all the Cheque and DD type instruments with status as :new and
     *
     * @return List of HashMap
     */
	/*
	 * @Override public List&lt;ReceiptBean&gt;
	 * findChequeRemittanceDetailsForServiceAndFund(final String boundaryIdList,
	 * final String serviceCodes, final String fundCodes, final Date startDate,
	 * final Date endDate, String serviceTypeId) { // TODO : need to make this call
	 * to mdms // FinancialStatus status =
	 * microserviceUtils.getInstrumentStatusByCode(CollectionConstants.
	 * INSTRUMENT_NEW_STATUS); String instrumentTypes =
	 * CollectionConstants.INSTRUMENTTYPE_NAME_CHEQUE + &quot;,&quot; +
	 * CollectionConstants.INSTRUMENTTYPE_NAME_DD; List&lt;Instrument&gt; instruments =
	 * microserviceUtils.getInstruments(instrumentTypes, TransactionType.Debit,
	 * CollectionConstants.INSTRUMENT_NEW_STATUS); Map&lt;String, Instrument&gt;
	 * receiptInstrumentMap = new HashMap&lt;&gt;(); List&lt;String&gt; receiptIds = new
	 * ArrayList&lt;&gt;(); for (Instrument i : instruments) { if
	 * (i.getInstrumentVouchers() != null) for (InstrumentVoucher iv :
	 * i.getInstrumentVouchers()) {
	 * receiptInstrumentMap.put(iv.getReceiptHeaderId(), i);
	 * receiptIds.add(iv.getReceiptHeaderId()); } } ReceiptBean rb;
	 * List&lt;ReceiptBean&gt; finalList = new ArrayList&lt;&gt;();
	 * if(!receiptInstrumentMap.isEmpty() &amp;&amp; !receiptIds.isEmpty()){ switch
	 * (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) { case &quot;V2&quot;:
	 * case &quot;VERSION2&quot;: List&lt;Payment&gt; payments = microserviceUtils.getPayments(
	 * PaymentSearchCriteria.builder() .ids(new HashSet(receiptIds))
	 * .status(Collections.singleton(PaymentStatusEnum.NEW.name()))
	 * .businessServices(Arrays.asList(serviceCodes.split(&quot;,&quot;)).stream().collect(
	 * Collectors.toSet())) .fromDate(startDate.getTime())
	 * .toDate(endDate.getTime()) .build() ); payments.stream().filter(payment -&gt;
	 * receiptInstrumentMap.containsKey(payment.getId())).forEach(payment -&gt; {
	 * Set&lt;String&gt; receiptNumbers =
	 * payment.getPaymentDetails().stream().map(PaymentDetail::getReceiptNumber).
	 * collect(Collectors.toSet()); Set&lt;String&gt; services =
	 * payment.getPaymentDetails().stream().map(PaymentDetail::getBusinessService).
	 * collect(Collectors.toSet()); ReceiptBean rb1 = new ReceiptBean();
	 * rb1.setInstrumentId(receiptInstrumentMap.get(payment.getId()).getId());
	 * rb1.setInstrumentAmount(receiptInstrumentMap.get(payment.getId()).getAmount()
	 * ); rb1.setInstrumentNumber(receiptInstrumentMap.get(payment.getId()).
	 * getTransactionNumber()); if
	 * (receiptInstrumentMap.get(payment.getId()).getTransactionDate() != null)
	 * rb1.setInstrumentDate(DateUtils.toDefaultDateFormat(
	 * receiptInstrumentMap.get(payment.getId()) .getTransactionDate()));
	 * rb1.setInstrumentType(
	 * receiptInstrumentMap.get(payment.getId()).getInstrumentType().getName());
	 * rb1.setBankBranch(receiptInstrumentMap.get(payment.getId()).getBranchName());
	 * // final Bank bank = (Bank) persistenceService.find(&quot;from Bank where id=?&quot;,
	 * // receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getBank().getId().intValue());
	 * org.egov.infra.microservice.models.Bank bank =
	 * receiptInstrumentMap.get(payment.getId()).getBank(); rb1.setBank(bank != null
	 * ? bank.getName() : &quot;&quot;); rb1.setReceiptId(payment.getId());
	 * rb1.setReceiptNumber(StringUtils.join(receiptNumbers,&quot;,&quot;));
	 * rb1.setReceiptDate(DateUtils.toDefaultDateTimeFormat(new
	 * Date(payment.getTransactionDate())));
	 * rb1.setService(StringUtils.join(services,&quot;,&quot;)); finalList.add(rb1); });
	 * 
	 * break;
	 * 
	 * default: List&lt;Receipt&gt; receipts =
	 * microserviceUtils.getReceipts(StringUtils.join(receiptIds, &quot;,&quot;),
	 * CollectionConstants.RECEIPT_STATUS_APPROVED, serviceCodes, startDate,
	 * endDate, serviceTypeId);
	 * 
	 * for (Receipt r : receipts) { rb = new ReceiptBean();
	 * rb.setInstrumentId(receiptInstrumentMap.get(r.getBill().get(0).getBillDetails
	 * ().get(0).getReceiptNumber()).getId());
	 * rb.setInstrumentAmount(receiptInstrumentMap.get(r.getBill().get(0).
	 * getBillDetails().get(0).getReceiptNumber()).getAmount());
	 * rb.setInstrumentNumber(
	 * receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getTransactionNumber()); if
	 * (receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getTransactionDate() != null)
	 * rb.setInstrumentDate(DateUtils.toDefaultDateFormat(
	 * receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()) .getTransactionDate())); rb.setInstrumentType(
	 * receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getInstrumentType().getName());
	 * rb.setBankBranch(receiptInstrumentMap.get(r.getBill().get(0).getBillDetails()
	 * .get(0).getReceiptNumber()).getBranchName()); // final Bank bank = (Bank)
	 * persistenceService.find(&quot;from Bank where id=?&quot;, //
	 * receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getBank().getId().intValue());
	 * org.egov.infra.microservice.models.Bank bank =
	 * receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()).getBank(); rb.setBank(bank != null ? bank.getName() :
	 * &quot;&quot;);
	 * rb.setReceiptId(r.getBill().get(0).getBillDetails().get(0).getReceiptNumber()
	 * ); rb.setReceiptNumber(r.getBill().get(0).getBillDetails().get(0).
	 * getReceiptNumber()); rb.setReceiptDate( DateUtils.toDefaultDateTimeFormat(new
	 * Date(r.getBill().get(0).getBillDetails().get(0).getReceiptDate())));
	 * rb.setService(r.getBill().get(0).getBillDetails().get(0).getBusinessService()
	 * ); rb.setFund(r.getBill().get(0).getBillDetails().get(0).getFund());
	 * rb.setDepartment(r.getBill().get(0).getBillDetails().get(0).getDepartment());
	 * finalList.add(rb); } break;
	 * 
	 * }
	 * 
	 * populateNames(finalList); } return finalList; }
	 */
    
    
    
   // Changes By Prasanta
    /**
     * Method to find all the Cheque and DD type instruments with status as :new and
     *
     * @return List of HashMap
     */
    @Override
    public List&lt;ReceiptBean&gt; findChequeRemittanceDetailsForServiceAndFund(String classification, Date startDate, Date endDate, String businessCode,
            String receiptNo,String type) {
        // TODO : need to make this call to mdms
//        FinancialStatus status = microserviceUtils.getInstrumentStatusByCode(CollectionConstants.INSTRUMENT_NEW_STATUS);
<span class="nc" id="L1680">        String instrumentTypes = CollectionConstants.INSTRUMENTTYPE_NAME_CHEQUE + &quot;,&quot;</span>
                + CollectionConstants.INSTRUMENTTYPE_NAME_DD;
		/*
		 * List&lt;Instrument&gt; instruments =
		 * microserviceUtils.getInstruments(instrumentTypes, TransactionType.Debit,
		 * CollectionConstants.INSTRUMENT_NEW_STATUS); Map&lt;String, Instrument&gt;
		 * receiptInstrumentMap = new HashMap&lt;&gt;(); List&lt;String&gt; receiptIds = new
		 * ArrayList&lt;&gt;(); for (Instrument i : instruments) { if
		 * (i.getInstrumentVouchers() != null) for (InstrumentVoucher iv :
		 * i.getInstrumentVouchers()) {
		 * receiptInstrumentMap.put(iv.getReceiptHeaderId(), i);
		 * receiptIds.add(iv.getReceiptHeaderId()); } }
		 */
        ReceiptBean rb;
<span class="nc" id="L1694">        List&lt;ReceiptBean&gt; finalList = new ArrayList&lt;&gt;();</span>
        //if(!receiptInstrumentMap.isEmpty() &amp;&amp; !receiptIds.isEmpty()){
		/*
		 * switch (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) { case
		 * &quot;V2&quot;: case &quot;VERSION2&quot;: List&lt;Payment&gt; payments =
		 * microserviceUtils.getPayments( PaymentSearchCriteria.builder() .ids(new
		 * HashSet(receiptIds))
		 * .status(Collections.singleton(PaymentStatusEnum.NEW.name()))
		 * //.businessServices(Arrays.asList(serviceCodes.split(&quot;,&quot;)).stream().collect(
		 * Collectors.toSet())) .fromDate(startDate.getTime())
		 * .toDate(endDate.getTime()) .build() ); payments.stream().filter(payment -&gt;
		 * receiptInstrumentMap.containsKey(payment.getId())).forEach(payment -&gt; {
		 * Set&lt;String&gt; receiptNumbers =
		 * payment.getPaymentDetails().stream().map(PaymentDetail::getReceiptNumber).
		 * collect(Collectors.toSet()); Set&lt;String&gt; services =
		 * payment.getPaymentDetails().stream().map(PaymentDetail::getBusinessService).
		 * collect(Collectors.toSet()); ReceiptBean rb1 = new ReceiptBean();
		 * rb1.setInstrumentId(receiptInstrumentMap.get(payment.getId()).getId());
		 * rb1.setInstrumentAmount(receiptInstrumentMap.get(payment.getId()).getAmount()
		 * ); rb1.setInstrumentNumber(receiptInstrumentMap.get(payment.getId()).
		 * getTransactionNumber()); if
		 * (receiptInstrumentMap.get(payment.getId()).getTransactionDate() != null)
		 * rb1.setInstrumentDate(DateUtils.toDefaultDateFormat(
		 * receiptInstrumentMap.get(payment.getId()) .getTransactionDate()));
		 * rb1.setInstrumentType(
		 * receiptInstrumentMap.get(payment.getId()).getInstrumentType().getName());
		 * rb1.setBankBranch(receiptInstrumentMap.get(payment.getId()).getBranchName());
		 * // final Bank bank = (Bank) persistenceService.find(&quot;from Bank where id=?&quot;,
		 * // receiptInstrumentMap.get(r.getBill().get(0).getBillDetails().get(0).
		 * getReceiptNumber()).getBank().getId().intValue());
		 * org.egov.infra.microservice.models.Bank bank =
		 * receiptInstrumentMap.get(payment.getId()).getBank(); rb1.setBank(bank != null
		 * ? bank.getName() : &quot;&quot;); rb1.setReceiptId(payment.getId());
		 * rb1.setReceiptNumber(StringUtils.join(receiptNumbers,&quot;,&quot;));
		 * rb1.setReceiptDate(DateUtils.toDefaultDateTimeFormat(new
		 * Date(payment.getTransactionDate())));
		 * rb1.setService(StringUtils.join(services,&quot;,&quot;)); finalList.add(rb1); });
		 * 
		 * break;
		 * 
		 * default:
		 */        	
            
            
<span class="nc" id="L1738">            	 List&lt;Receipt&gt; receipts  = microserviceUtils.searchRecieptsFin(classification,startDate, endDate, businessCode, null, type);</span>
<span class="nc" id="L1739">            	 System.out.println(&quot;Inside METHOD  after &gt;&gt;&quot;+receipts);            </span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">            for (Receipt r : receipts) {</span>
<span class="nc bnc" id="L1741" title="All 2 branches missed.">                for (org.egov.infra.microservice.models.Bill bill : r.getBill()) {</span>
<span class="nc bnc" id="L1742" title="All 2 branches missed.">                    for (BillDetail billDetail : bill.getBillDetails()) {</span>
<span class="nc" id="L1743">                rb = new ReceiptBean();</span>
<span class="nc" id="L1744">                   	 	rb.setInstrumentId(r.getInstrument().getInstrumentType().getId());</span>
<span class="nc" id="L1745">                    	rb.setInstrumentAmount(billDetail.getTotalAmount());</span>
<span class="nc" id="L1746">                        rb.setInstrumentNumber(r.getInstrument().getInstrumentNumber());</span>
<span class="nc" id="L1747">                        rb.setInstrumentType(r.getInstrument().getInstrumentType().getName());</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                        if(r.getInstrument().getTransactionDate() !=null)</span>
<span class="nc" id="L1749">                        	rb.setInstrumentDate(DateUtils.toDefaultDateFormat(r.getInstrument().getTransactionDate()));</span>
                               
<span class="nc" id="L1751">                        rb.setBankBranch(r.getInstrument().getBranchName());</span>
<span class="nc" id="L1752">                        org.egov.infra.microservice.models.Bank bank = r.getInstrument().getBank();</span>
<span class="nc bnc" id="L1753" title="All 2 branches missed.">                rb.setBank(bank != null ? bank.getName() : &quot;&quot;);</span>
<span class="nc" id="L1754">                        rb.setReceiptId(r.getReceiptNumber());	</span>
<span class="nc" id="L1755">                        rb.setReceiptNumber(r.getReceiptNumber());</span>
                        
<span class="nc" id="L1757">                        rb.setReceiptId(r.getPaymentId());</span>
<span class="nc" id="L1758">                        rb.setReceiptNumber(billDetail.getReceiptNumber());</span>
<span class="nc" id="L1759">                       String receiptDate = DateUtils</span>
<span class="nc" id="L1760">                                .toDefaultDateFormat(new Date(r.getBill().get(0).getBillDetails().get(0).getReceiptDate()));</span>
<span class="nc" id="L1761">                        rb.setReceiptDate(receiptDate);</span>
                        
<span class="nc" id="L1763">                        rb.setService(billDetail.getBusinessService());</span>
<span class="nc" id="L1764">                        rb.setRemittanceReferenceNumber(billDetail.getBillNumber());</span>
<span class="nc" id="L1765">                        rb.setFund(billDetail.getFund());</span>
                       
<span class="nc" id="L1767">                        rb.setDepartment(billDetail.getDepartment());</span>
                        
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                        if((r.getInstrument().getInstrumentType().getName())!=&quot;CASH&quot;) {</span>
<span class="nc" id="L1770">                finalList.add(rb);</span>
            }
        
<span class="nc" id="L1773">        }</span>
<span class="nc" id="L1774">                }</span>

               
			/*
			 * } break;
			 */
        
       //}

<span class="nc" id="L1783">        populateNames(finalList);</span>
				 
						 
<span class="nc" id="L1786">        }</span>
<span class="nc" id="L1787">        return finalList;</span>
    }
    
    public List&lt;ReceiptBean&gt; findChequeRemittanceDetailsForServiceAndFund(String classification, Date fromDate, Date toDate, String businessCode,
            String receiptNo,String department,String type, String searchAmount, String subDivision,String collectedBy) {
        // TODO : need to make this call to mdms
//        FinancialStatus status = microserviceUtils.getInstrumentStatusByCode(CollectionConstants.INSTRUMENT_NEW_STATUS);
<span class="nc" id="L1794">        String instrumentTypes = CollectionConstants.INSTRUMENTTYPE_NAME_CHEQUE + &quot;,&quot;</span>
                + CollectionConstants.INSTRUMENTTYPE_NAME_DD;
		
        ReceiptBean rb;
<span class="nc" id="L1798">        List&lt;ReceiptBean&gt; finalList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1799">        boolean amountcheck=false;</span>
<span class="nc" id="L1800">    	boolean deptcheck=false;</span>
<span class="nc" id="L1801">    	boolean subdivisioncheck=false; </span>
<span class="nc" id="L1802">    	boolean receiptcheck=false;</span>
<span class="nc" id="L1803">    	boolean collectedcheck=false;</span>
    	
<span class="nc" id="L1805">    	final StringBuffer query1 = new StringBuffer(500);</span>
<span class="nc" id="L1806">		List&lt;Object[]&gt; list1= null;</span>
<span class="nc" id="L1807">    	SQLQuery queryMain =  null;</span>
<span class="nc" id="L1808">    	query1</span>
<span class="nc" id="L1809">        .append(&quot;select v2.reciept_number, v2.departmentcode, fnc.code as fnccode from vouchermis v2,\&quot;function\&quot; fnc where v2.reciept_number notnull and fnc.id  = v2.functionid&quot;);</span>
<span class="nc" id="L1810">    	queryMain=this.persistenceService.getSession().createSQLQuery(query1.toString());</span>
<span class="nc" id="L1811">    	list1 = queryMain.list();</span>
<span class="nc" id="L1812">    	System.out.println(&quot;:::list size::::: &quot;+list1.size());	</span>
<span class="nc" id="L1813">    	Map&lt;String, String&gt; deptMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1814">    	Map&lt;String, String&gt; funMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">    	if(list1!=null)</span>
    	{
<span class="nc bnc" id="L1817" title="All 2 branches missed.">    		for (final Object[] object : list1)</span>
    		{
<span class="nc" id="L1819">    			deptMap.put(object[0].toString(), object[1].toString());</span>
<span class="nc" id="L1820">    			funMap.put(object[0].toString(), object[2].toString());</span>
<span class="nc" id="L1821">    		}</span>
    	}
    	
<span class="nc" id="L1824">    	 List&lt;Receipt&gt; receipts  = null;//microserviceUtils.searchRecieptsFinNew(classification, fromDate, toDate, businessCode, null, type);</span>
        //List&lt;Receipt&gt; receipts  = microserviceUtils.searchRecieptsFin(classification,startDate, endDate, businessCode, null, type);
<span class="nc" id="L1826">            	 System.out.println(&quot;Inside METHOD  after &gt;&gt;&quot;+receipts); </span>
            	 
<span class="nc bnc" id="L1828" title="All 2 branches missed.">            for (Receipt r : receipts) {</span>
	 /*
                for (org.egov.infra.microservice.models.Bill bill : r.getBill()) {
                    for (BillDetail billDetail : bill.getBillDetails()) {
                rb = new ReceiptBean();
                   	 	rb.setInstrumentId(r.getInstrument().getInstrumentType().getId());
                    	rb.setInstrumentAmount(billDetail.getTotalAmount());
                        rb.setInstrumentNumber(r.getInstrument().getInstrumentNumber());
                        rb.setInstrumentType(r.getInstrument().getInstrumentType().getName());
                        if(r.getInstrument().getTransactionDate() !=null)
                        	rb.setInstrumentDate(DateUtils.toDefaultDateFormat(r.getInstrument().getTransactionDate()));
                               
	  
                        rb.setBankBranch(r.getInstrument().getBranchName());
                        org.egov.infra.microservice.models.Bank bank = r.getInstrument().getBank();
                        rb.setBank(bank != null ? bank.getName() : &quot;&quot;);
                        rb.setReceiptId(r.getReceiptNumber());	
                        rb.setReceiptNumber(r.getReceiptNumber());
                        
                        rb.setReceiptId(r.getPaymentId());
                        rb.setReceiptNumber(billDetail.getReceiptNumber());
                        String receiptDate = DateUtils
                                .toDefaultDateFormat(new Date(r.getBill().get(0).getBillDetails().get(0).getReceiptDate()));
																		 
                        rb.setReceiptDate(receiptDate);
                        
                        rb.setService(billDetail.getBusinessService());
                        rb.setRemittanceReferenceNumber(billDetail.getBillNumber());
                        rb.setFund(billDetail.getFund()!=null ? billDetail.getFund() :&quot;Municipal (General) Fund&quot;);
                        if(deptMap.containsKey(r.getReceiptNumber()))
		    			{
                        	rb.setDepartment(deptMap.get(r.getReceiptNumber()));
		    			}
                        else {
                        	rb.setDepartment(billDetail.getDepartment());
                        }
                        if(funMap.containsKey(r.getReceiptNumber()))
                        {
                        	rb.setFunctionCode(funMap.get(r.getReceiptNumber()));
                        }
                        else {
                        	rb.setFunctionCode(null);
                        }
                        System.out.println(&quot;dept &quot;+rb.getDepartment());
                        rb.setCreatedUser(r.getCollectedByName());
                        BigDecimal searchamt = new BigDecimal(0);
	                 	if(searchAmount!=null &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;&quot;) &amp;&amp; !searchAmount.equalsIgnoreCase(&quot;0&quot;)) {
														  
	                 		searchamt=new BigDecimal(Integer.parseInt(searchAmount));
	                 		amountcheck=true;
	                 	}
	                 	if(!subDivision.equalsIgnoreCase(&quot;-1&quot;))
	                 	{
	                 		subdivisioncheck=true;
	                 	}
	                 	if(!department.equalsIgnoreCase(&quot;-1&quot;))
	                 	{
	                 		deptcheck=true;
	                 	}
	                 	if(receiptNo!=null &amp;&amp; !receiptNo.equalsIgnoreCase(&quot;&quot;)) {
	                		receiptcheck=true;
	                	}
	                 	if(collectedBy!=null &amp;&amp; !collectedBy.equalsIgnoreCase(&quot;&quot;)) {
	                		collectedcheck=true;
	                	}
                        if(((r.getInstrument().getInstrumentType().getName()).equalsIgnoreCase(&quot;CHEQUE&quot;) ||
				  
                        		(r.getInstrument().getInstrumentType().getName()).equalsIgnoreCase(&quot;DD&quot;))&amp;&amp;
                        		r.getPaymentStatus().equalsIgnoreCase(&quot;NEW&quot;)) 
                        {	
                            	if(amountcheck)
                            	{
                            		if(searchamt.compareTo(r.getInstrument().getAmount())==0) {}
                            		else
                            			continue;
                            	}
                            	if(subdivisioncheck)
                            	{
                            		if(subDivision.equalsIgnoreCase(r.getSubdivison())) {}
                            		else
                            			continue;
                            	}
                            	 if(deptcheck)
                            	{
                            		if(department.equalsIgnoreCase(rb.getDepartment())) {}
                            		else
                            			continue;
                            	}
                            	if(receiptcheck)
                            	{
                            		if(receiptNo.equalsIgnoreCase(r.getReceiptNumber())) {}
                            		else
                            			continue;
                            	}
                            	if(collectedcheck)
                            	{
                            		if(collectedBy.equalsIgnoreCase(r.getCollectedByName())) {}
                            		else
                            			continue;
                            	}
                            	finalList.add(rb);
                            	
                         }
			        }
                }
                populateNames(finalList);
<span class="nc" id="L1934">       */ }</span>
<span class="nc" id="L1935">        return finalList;</span>
    }

    private List&lt;Object[]&gt; populateOtherDetails(List&lt;Receipt&gt; receipts) 
    {
    	
<span class="nc" id="L1941">	    	final StringBuffer query1 = new StringBuffer(500);</span>
<span class="nc" id="L1942">			List&lt;Object[]&gt; list1= null;</span>
<span class="nc" id="L1943">	    	SQLQuery queryMain =  null;</span>
<span class="nc" id="L1944">	    	query1</span>
<span class="nc" id="L1945">	    	.append(&quot;select gl.id,gl.glcode,gl.debitamount,gl.creditamount,v2.departmentcode,v2.reciept_number from generalledger gl left join vouchermis v2 on gl.voucherheaderid =v2.voucherheaderid where v2.reciept_number notnull &quot;);</span>
	    	
<span class="nc" id="L1947">	    	queryMain=this.persistenceService.getSession().createSQLQuery(query1.toString());</span>
<span class="nc" id="L1948">	    	list1 = queryMain.list();</span>
<span class="nc" id="L1949">	    	System.out.println(&quot;:::list size::::: &quot;+list1.size());	</span>
<span class="nc bnc" id="L1950" title="All 2 branches missed.">	    	if(list1!=null)</span>
	    	{
	    		
	    	}
<span class="nc" id="L1954">    	return list1;</span>
    			    	    
	}
    
    public void setCollectionsUtil(final CollectionsUtil collectionsUtil) {
<span class="nc" id="L1959">        this.collectionsUtil = collectionsUtil;</span>
<span class="nc" id="L1960">    }</span>

    public void setFinancialsUtil(final FinancialsUtil financialsUtil) {
<span class="nc" id="L1963">        this.financialsUtil = financialsUtil;</span>
<span class="nc" id="L1964">    }</span>

    public void setReceiptHeaderService(final ReceiptHeaderService receiptHeaderService) {
<span class="nc" id="L1967">        this.receiptHeaderService = receiptHeaderService;</span>
<span class="nc" id="L1968">    }</span>

    public CollectionsNumberGenerator getCollectionsNumberGenerator() {
<span class="nc" id="L1971">        return collectionsNumberGenerator;</span>
    }

    public void setCollectionsNumberGenerator(final CollectionsNumberGenerator collectionsNumberGenerator) {
<span class="nc" id="L1975">        this.collectionsNumberGenerator = collectionsNumberGenerator;</span>
<span class="nc" id="L1976">    }</span>

    public void setPersistenceService(final PersistenceService persistenceService) {
<span class="nc" id="L1979">        this.persistenceService = persistenceService;</span>
<span class="nc" id="L1980">    }</span>

    public void setRemittancePersistService(final PersistenceService&lt;Remittance, Long&gt; remittancePersistService) {
<span class="nc" id="L1983">        this.remittancePersistService = remittancePersistService;</span>
<span class="nc" id="L1984">    }</span>

    @Transactional
    @Override
    public List&lt;Receipt&gt; createChequeBankRemittance(List&lt;ReceiptBean&gt; receiptBeanList, String accountNumberId,
            Date remittanceDate, String[] instrumentIdArray) {

<span class="nc" id="L1991">        List&lt;Receipt&gt; receiptList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1992">        final SimpleDateFormat dateFomatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;, Locale.getDefault());</span>
<span class="nc" id="L1993">        InstrumentAccountCode accountCode = microserviceUtils</span>
<span class="nc" id="L1994">                .getInstrumentAccountGlCodeByType(CollectionConstants.INSTRUMENTTYPE_NAME_CHEQUE);</span>

<span class="nc" id="L1996">        final String cashInHandQueryString = &quot;SELECT COA.GLCODE FROM CHARTOFACCOUNTS COA WHERE COA.GLCODE = '&quot;</span>
<span class="nc" id="L1997">                + accountCode.getGlcode()</span>
                + &quot;'&quot;;
<span class="nc" id="L1999">        final Query chequeInHand = persistenceService.getSession().createSQLQuery(cashInHandQueryString);</span>

<span class="nc" id="L2001">        String chequeInHandGlcode = null;</span>

<span class="nc bnc" id="L2003" title="All 2 branches missed.">        if (!chequeInHand.list().isEmpty()){</span>
<span class="nc" id="L2004">            chequeInHandGlcode = chequeInHand.list().get(0).toString();</span>
        }else{
<span class="nc" id="L2006">            String validationMessage = String.format(&quot;Glcode: %1$s which  is mapped with Istrument type cheque in mdms is not exist in database&quot;,  accountCode.getGlcode());</span>
<span class="nc" id="L2007">            throw new ValidationException(Arrays.asList(new ValidationError(validationMessage, validationMessage)));</span>
        }

<span class="nc" id="L2010">        String functionCode = collectionsUtil.getAppConfigValue(CollectionConstants.MODULE_NAME_COLLECTIONS_CONFIG,</span>
                CollectionConstants.APPCONFIG_VALUE_COLLECTION_BANKREMITTANCE_FUNCTIONCODE);

<span class="nc" id="L2013">        List&lt;String&gt; instrumentIdList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2014">        Boolean showRemitDate = true;</span>
<span class="nc" id="L2015">        BigDecimal totalChequeAmount = BigDecimal.ZERO;</span>
<span class="nc" id="L2016">        BigDecimal totalChequeVoucherAmt = BigDecimal.ZERO;</span>
<span class="nc" id="L2017">        String fundCode = &quot;&quot;;</span>
<span class="nc" id="L2018">        Date voucherDate = null;</span>
<span class="nc" id="L2019">        if (collectionsUtil</span>
<span class="nc" id="L2020">                .getAppConfigValue(CollectionConstants.MODULE_NAME_COLLECTIONS_CONFIG,</span>
                        CollectionConstants.APPCONFIG_VALUE_COLLECTION_BANKREMITTANCE_SHOWREMITDATE)
<span class="nc bnc" id="L2022" title="All 2 branches missed.">                .equals(CollectionConstants.YES))</span>
<span class="nc" id="L2023">            showRemitDate = true;</span>

<span class="nc" id="L2025">        final Bankaccount depositedBankAccount = (Bankaccount) persistenceService.find(&quot;from Bankaccount where accountnumber=?&quot;,</span>
                accountNumberId);
<span class="nc" id="L2027">        final String serviceGlCode = depositedBankAccount.getChartofaccounts().getGlcode();</span>

<span class="nc" id="L2029">        Boolean voucherTypeForChequeDDCard = false;</span>
<span class="nc" id="L2030">        if (collectionsUtil.getAppConfigValue(CollectionConstants.MODULE_NAME_COLLECTIONS_CONFIG,</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">                CollectionConstants.APPCONFIG_VALUE_REMITTANCEVOUCHERTYPEFORCHEQUEDDCARD).equals(</span>
                        CollectionConstants.FINANCIAL_RECEIPTS_VOUCHERTYPE))
<span class="nc" id="L2033">            voucherTypeForChequeDDCard = true;</span>

<span class="nc" id="L2035">        List&lt;BusinessService&gt; businessDetailsList = microserviceUtils.getBusinessService(null);</span>
<span class="nc" id="L2036">        Map&lt;String, BusinessService&gt; businessDetailsMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">        for (BusinessService bd : businessDetailsList) {</span>
<span class="nc" id="L2038">            businessDetailsMap.put(bd.getCode(), bd);</span>
<span class="nc" id="L2039">        }</span>
<span class="nc" id="L2040">        BusinessService businessDetails = null;</span>
<span class="nc" id="L2041">        String createVoucher = &quot;N&quot;;</span>
<span class="nc" id="L2042">        StringBuffer receiptNumbers = new StringBuffer();</span>
<span class="nc" id="L2043">        Map&lt;String, Set&lt;Instrument&gt;&gt; receiptInstrumentMap = new HashMap&lt;&gt;();</span>
        List&lt;Instrument&gt; instruments;
<span class="nc" id="L2045">        Set&lt;String&gt; paymentIdSet = new HashSet();</span>
<span class="nc bnc" id="L2046" title="All 2 branches missed.">        for (ReceiptBean receipt : receiptBeanList) {</span>
            
<span class="nc bnc" id="L2048" title="All 4 branches missed.">            if (receipt.getSelected() != null &amp;&amp; receipt.getSelected()) {</span>
<span class="nc" id="L2049">                instruments = microserviceUtils.getInstruments(receipt.getInstrumentId());</span>
<span class="nc" id="L2050">                receiptInstrumentMap.put(receipt.getReceiptId(), new HashSet&lt;&gt;(instruments));</span>
<span class="nc" id="L2051">                instrumentIdList.add(receipt.getInstrumentId());</span>
<span class="nc" id="L2052">                receiptNumbers.append(&quot;,&quot;);</span>
<span class="nc bnc" id="L2053" title="All 9 branches missed.">                switch(ApplicationThreadLocals.getCollectionVersion().toUpperCase()){</span>
                case &quot;V2&quot;:
                case &quot;VERSION2&quot;:
<span class="nc" id="L2056">                    receiptNumbers.append(receipt.getReceiptId());</span>
<span class="nc" id="L2057">                    paymentIdSet.add(receipt.getReceiptId());</span>
<span class="nc" id="L2058">                    break;</span>
                default:
<span class="nc" id="L2060">                    receiptNumbers.append(receipt.getReceiptNumber());</span>
                    break;
                }

<span class="nc bnc" id="L2064" title="All 4 branches missed.">                if (showRemitDate &amp;&amp; remittanceDate != null)</span>
<span class="nc" id="L2065">                    voucherDate = remittanceDate;</span>
                else
                    try {
<span class="nc" id="L2068">                        voucherDate = collectionsUtil.getRemittanceVoucherDate(dateFomatter.parse(receipt.getReceiptDate()));</span>
<span class="nc" id="L2069">                    } catch (final ParseException e) {</span>
<span class="nc" id="L2070">                        LOGGER.error(&quot;Error Parsing Date&quot;, e);</span>
<span class="nc" id="L2071">                    }</span>

<span class="nc" id="L2073">                businessDetails = businessDetailsMap.get(receipt.getService());</span>

                // If Cheque Amount is present
<span class="nc bnc" id="L2076" title="All 4 branches missed.">                if (receipt.getInstrumentAmount() != null &amp;&amp; chequeInHandGlcode != null) {</span>
<span class="nc" id="L2077">                    List&lt;CVoucherHeader&gt; voucher = this.getVoucher(instruments.get(0).getInstrumentVouchers().get(0).getVoucherHeaderId());</span>
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                    if(!voucher.isEmpty()){</span>
<span class="nc" id="L2079">                        fundCode = voucher.get(0).getFundId().getCode();</span>
<span class="nc" id="L2080">                        functionCode = voucher.get(0).getVouchermis().getFunction().getCode();</span>
                    }else{
<span class="nc" id="L2082">                        String validationMessage = &quot;Voucher is not exist for receipt: &quot;+receipt.getReceiptNumber()+&quot;, contact to system administrator.&quot;;</span>
<span class="nc" id="L2083">                        throw new ValidationException(Arrays.asList(new ValidationError(validationMessage, validationMessage)));</span>
                    }
<span class="nc" id="L2085">                    totalChequeAmount = totalChequeAmount.add(receipt.getInstrumentAmount());</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                    if (businessDetails.isVoucherCreationEnabled()) {</span>
<span class="nc" id="L2087">                        createVoucher = &quot;Y&quot;;</span>
<span class="nc" id="L2088">                        totalChequeVoucherAmt = totalChequeVoucherAmt.add(receipt.getInstrumentAmount());</span>
                    } else {
<span class="nc" id="L2090">                        microserviceUtils.depositeInstruments(instruments, depositedBankAccount.getAccountnumber());</span>
                    }
                }

            }
<span class="nc" id="L2095">        }</span>

<span class="nc" id="L2097">        receiptList = microserviceUtils.getReceipts(receiptNumbers.toString());</span>
<span class="nc" id="L2098">        final Map&lt;String, Object&gt; instrumentDepositMap = financialsUtil.prepareForUpdateInstrumentDepositSQL();</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        if (totalChequeVoucherAmt.compareTo(totalChequeAmount) != 0) {</span>
<span class="nc" id="L2100">            String validationMessage = &quot;There is a difference of amount &quot; + totalChequeAmount.subtract(totalChequeVoucherAmt)</span>
                    + &quot; between bank challan and the remittance voucher , please contact system administrator &quot;;
<span class="nc" id="L2102">            throw new ValidationException(Arrays.asList(new ValidationError(validationMessage, validationMessage)));</span>
        }
<span class="nc" id="L2104">        String subdivisonNew=&quot;&quot;;</span>
<span class="nc" id="L2105">        final Remittance remittance = populateAndPersistRemittance(BigDecimal.ZERO, totalChequeAmount, fundCode, null,</span>
                chequeInHandGlcode, serviceGlCode, functionCode, new HashSet(receiptList), createVoucher,
                voucherDate, depositedBankAccount, BigDecimal.ZERO, totalChequeVoucherAmt,
                instrumentIdList, receiptInstrumentMap,subdivisonNew);

        // For cheque update instrument status to deposited.
<span class="nc bnc" id="L2111" title="All 2 branches missed.">        for (final RemittanceInstrument bankRemitInstrument : remittance.getRemittanceInstruments()) {</span>
<span class="nc" id="L2112">            final Map&lt;String, Object&gt; chequeMap = remittanceSchedulerService.constructInstrumentMap(instrumentDepositMap,</span>
<span class="nc" id="L2113">                    depositedBankAccount, bankRemitInstrument.getInstrument(), remittance.getVoucherHeader());</span>
<span class="nc bnc" id="L2114" title="All 2 branches missed.">            if (voucherTypeForChequeDDCard)</span>
<span class="nc" id="L2115">                financialsUtil.updateCheque_DD_Card_Deposit_Receipt(chequeMap);</span>
            else
<span class="nc" id="L2117">                financialsUtil.updateCheque_DD_Card_Deposit(chequeMap, remittance.getVoucherHeader(),</span>
<span class="nc" id="L2118">                        bankRemitInstrument.getInstrumentHeader(), depositedBankAccount);</span>
<span class="nc" id="L2119">        }</span>
        
<span class="nc bnc" id="L2121" title="All 9 branches missed.">        switch (ApplicationThreadLocals.getCollectionVersion().toUpperCase()) {</span>
        case &quot;V2&quot;:
        case &quot;VERSION2&quot;:
<span class="nc bnc" id="L2124" title="All 2 branches missed.">            if(!paymentIdSet.isEmpty()){</span>
<span class="nc" id="L2125">                microserviceUtils.performWorkflow(paymentIdSet,PaymentWorkflow.PaymentAction.REMIT, &quot;Payment got remitted from finance&quot;);</span>
            }
            break;

        default:
<span class="nc bnc" id="L2130" title="All 2 branches missed.">            for (final Receipt receiptHeader : receiptList) {</span>
<span class="nc" id="L2131">                receiptHeader.getBill().get(0).getBillDetails().get(0).setStatus(&quot;Remitted&quot;);</span>
<span class="nc" id="L2132">                receiptHeader.getInstrument().setTenantId(receiptHeader.getTenantId());</span>
<span class="nc" id="L2133">                receiptHeader.getBill().get(0).setPayerName(receiptHeader.getBill().get(0).getPaidBy());</span>
//                receiptHeader.setReceiptNumber(remittance.getReferenceNumber());
<span class="nc" id="L2135">            }</span>
            //ReceiptResponse response = microserviceUtils.updateReceipts(new ArrayList&lt;&gt;(receiptList));
            break;
        }
<span class="nc bnc" id="L2139" title="All 2 branches missed.">        for (ReceiptBean receipt : receiptBeanList) {</span>
<span class="nc" id="L2140">            receipt.setRemittanceReferenceNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L2141">        }</span>
<span class="nc" id="L2142">        return receiptList;</span>
    }
    
    @Transactional
    public ReceiptBean createChequeBankRemittance(ReceiptBean receiptBeanList, List&lt;RemitancePOJO&gt; rp, Date remittanceDate,String narration,String deptIdnew,String functionNew,String receiptNumbers) {  

<span class="nc" id="L2148">    	final SimpleDateFormat dateFomatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;, Locale.getDefault());</span>
<span class="nc" id="L2149">        InstrumentAccountCode accountCode = microserviceUtils.getInstrumentAccountGlCodeByType(CollectionConstants.INSTRUMENTTYPE_NAME_CHEQUE);</span>
<span class="nc" id="L2150">        final String cashInHandQueryString = &quot;SELECT COA.GLCODE FROM CHARTOFACCOUNTS COA WHERE COA.GLCODE = '&quot;</span>
<span class="nc" id="L2151">                + accountCode.getGlcode()+ &quot;'&quot;;</span>
<span class="nc" id="L2152">        final Query chequeInHand = persistenceService.getSession().createSQLQuery(cashInHandQueryString);</span>
<span class="nc" id="L2153">		String chequeInHandGlcode = null;</span>

<span class="nc bnc" id="L2155" title="All 2 branches missed.">        if (!chequeInHand.list().isEmpty()){</span>
<span class="nc" id="L2156">            chequeInHandGlcode = chequeInHand.list().get(0).toString();</span>
        }

<span class="nc" id="L2159">        Map&lt;String,BigDecimal&gt; bankAccountMap=new HashMap&lt;String,BigDecimal&gt;();</span>
<span class="nc" id="L2160">        BigDecimal amt=null;</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">        for(RemitancePOJO row:rp)</span>
        {
<span class="nc bnc" id="L2163" title="All 2 branches missed.">        	if(bankAccountMap.get(row.getBankaccount()) == null )</span>
        	{
<span class="nc" id="L2165">        		amt=new BigDecimal(row.getAmount());</span>
<span class="nc" id="L2166">        		bankAccountMap.put(row.getBankaccount(),amt);</span>
        	}
        	else
        	{
<span class="nc" id="L2170">        		BigDecimal total=bankAccountMap.get(row.getBankaccount()).add(new BigDecimal(row.getAmount()));</span>
<span class="nc" id="L2171">        		bankAccountMap.put(row.getBankaccount(), total);</span>
        	}
<span class="nc" id="L2173">        }</span>

<span class="nc" id="L2175">        String createVoucher = &quot;N&quot;;</span>
<span class="nc" id="L2176">        Boolean showRemitDate = true;</span>
<span class="nc" id="L2177">        BigDecimal totalChequeVoucherAmt = BigDecimal.ZERO;</span>
<span class="nc" id="L2178">        String fundCode = &quot;&quot;;</span>
<span class="nc" id="L2179">        Date voucherDate = null;</span>
<span class="nc" id="L2180">        List&lt;Bankaccount&gt; depositedBankAccount = new ArrayList&lt;Bankaccount&gt;();</span>
<span class="nc" id="L2181">        Bankaccount b=null;</span>
<span class="nc" id="L2182">        Set&lt;String&gt; keys=bankAccountMap.keySet();</span>
<span class="nc" id="L2183">        Map&lt;String,BigDecimal&gt; serviceGlCodes = new HashMap&lt;String,BigDecimal&gt;();</span>
<span class="nc" id="L2184">        List&lt;BigDecimal&gt; totalChequeAmt = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L2185">        BigDecimal amt1=new BigDecimal(0);</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">        for(String key : keys)</span>
        {
<span class="nc" id="L2188">        	String[] accNum=key.split(&quot;-&quot;);</span>
<span class="nc" id="L2189">        	b=(Bankaccount) persistenceService.find(&quot;from Bankaccount where accountnumber=?&quot;,accNum[2]);</span>
<span class="nc" id="L2190">        	depositedBankAccount.add(b);</span>
<span class="nc" id="L2191">        	amt1=new BigDecimal(bankAccountMap.get(key).toString());</span>
<span class="nc" id="L2192">        	totalChequeAmt.add(amt1);</span>
<span class="nc" id="L2193">        	totalChequeVoucherAmt=totalChequeVoucherAmt.add(amt1);</span>
<span class="nc" id="L2194">        	serviceGlCodes.put(b.getChartofaccounts().getGlcode(),amt1);</span>
<span class="nc" id="L2195">        }</span>
        
<span class="nc bnc" id="L2197" title="All 2 branches missed.">            if (receiptBeanList.getSelected() != null) {</span>
<span class="nc bnc" id="L2198" title="All 4 branches missed.">                if (receiptBeanList.getFund() != null &amp;&amp; !receiptBeanList.getFund().isEmpty())</span>
                {
<span class="nc bnc" id="L2200" title="All 2 branches missed.">                	if(receiptBeanList.getFund().equalsIgnoreCase(&quot;Municipal (General) Fund&quot;))</span>
<span class="nc" id="L2201">                		fundCode=&quot;01&quot;;</span>
                	else
<span class="nc" id="L2203">                	fundCode = receiptBeanList.getFund();</span>
                }
<span class="nc bnc" id="L2205" title="All 4 branches missed.">                if (showRemitDate &amp;&amp; remittanceDate != null)</span>
<span class="nc" id="L2206">                    voucherDate = remittanceDate;</span>
                else
                {
                	try {
<span class="nc" id="L2210">                        voucherDate = collectionsUtil.getRemittanceVoucherDate(dateFomatter.parse(receiptBeanList.getReceiptDate()));</span>
<span class="nc" id="L2211">                    } catch (final ParseException e) {</span>
<span class="nc" id="L2212">                        LOGGER.error(&quot;Error Parsing Date&quot;, e);</span>
<span class="nc" id="L2213">                    }</span>
                }
<span class="nc bnc" id="L2215" title="All 4 branches missed.">                if (receiptBeanList.getService() != null &amp;&amp; receiptBeanList.getService().length() &gt; 0) {</span>
                    // If Cash Amount is present
<span class="nc bnc" id="L2217" title="All 4 branches missed.">                    if (receiptBeanList.getInstrumentAmount() != null &amp;&amp; chequeInHandGlcode != null) {</span>
<span class="nc" id="L2218">                        createVoucher = &quot;Y&quot;;</span>
<span class="nc" id="L2219">                        String functionCode=functionNew;//receiptBeanList.getFunctionCode();</span>
<span class="nc" id="L2220">                        String deptCode=deptIdnew;//receiptBeanList.getDepartment();</span>

<span class="nc" id="L2222">                        final Remittance remittance = populateAndPersistRemittanceNew(null, totalChequeAmt, fundCode,</span>
                                chequeInHandGlcode, null, serviceGlCodes, functionCode, receiptBeanList, createVoucher,
                                narration,voucherDate, depositedBankAccount, totalChequeVoucherAmt, BigDecimal.ZERO, Collections.EMPTY_LIST,
                                null,deptCode);
                        
<span class="nc" id="L2227">                        receiptBeanList.setRemittanceReferenceNumber(remittance.getReferenceNumber());</span>
<span class="nc" id="L2228">                        receiptBeanList.setRemittanceVouherNumber(remittance.getReferenceVoucherNumber());</span>
<span class="nc" id="L2229">                        receiptBeanList.setVoucherid(remittance.getVoucherid());</span>
<span class="nc bnc" id="L2230" title="All 2 branches missed.">                        for(String key : keys)</span>
                        {
                        	try {
<span class="nc" id="L2233">	                        MisRemittanceDetails mrd= new MisRemittanceDetails();</span>
<span class="nc" id="L2234">	                        mrd.setVoucher_number(remittance.getReferenceVoucherNumber());</span>
<span class="nc" id="L2235">	                        mrd.setVoucher_date(voucherDate);</span>
	                        //mrd.setMis_receipt_id(Long.valueOf(receiptBeanList.getReceiptId()));
<span class="nc" id="L2237">	                        mrd.setBankaccount(key);</span>
<span class="nc" id="L2238">	                        BigDecimal bankamt=new BigDecimal(bankAccountMap.get(key).toString());</span>
<span class="nc" id="L2239">	                        mrd.setAmount(bankamt);</span>
<span class="nc" id="L2240">	                        mrd.setDepartment(deptIdnew);</span>
<span class="nc" id="L2241">	                        mrd.setFunction(functionCode);</span>
<span class="nc" id="L2242">	                        mrd.setNarration(narration);</span>
	                        //mrd.setSubdivison(subdivisonNew);
<span class="nc" id="L2244">	                        mrd.setReceiptnumbers(receiptNumbers);</span>
<span class="nc" id="L2245">	                        misRemittanceDetailService.create(mrd);</span>
                        	}
<span class="nc" id="L2247">                        	catch(Exception e)</span>
                        	{
<span class="nc" id="L2249">                        		e.printStackTrace();</span>
<span class="nc" id="L2250">                        	}</span>
<span class="nc" id="L2251">                        }</span>
                    }
                }
            }
        
       
        
<span class="nc" id="L2258">        return receiptBeanList;</span>
    }

    private List&lt;CVoucherHeader&gt; getVoucher(String voucherHeaderId) {
<span class="nc" id="L2262">        final String sqlQuery = &quot;from CVoucherHeader vh where voucherNumber=:voucherNumber&quot;;</span>
<span class="nc" id="L2263">        final Query query = persistenceService.getSession().createQuery(sqlQuery);</span>
<span class="nc" id="L2264">        query.setParameter(&quot;voucherNumber&quot;, voucherHeaderId);</span>
<span class="nc" id="L2265">        return query.list();</span>
    }
    
    
    public List&lt;String&gt; getallBank(){
<span class="nc" id="L2270">    	final StringBuffer query1 = new StringBuffer(500);</span>
<span class="nc" id="L2271">    	List&lt;Object[]&gt; list1= null;</span>
<span class="nc" id="L2272">    	SQLQuery queryMain =  null;</span>
<span class="nc" id="L2273">    	List&lt;String&gt; banklist=new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2274">    	query1</span>
<span class="nc" id="L2275">        .append(&quot;select b3.name,b2.branchcode,b.accountnumber from bankaccount b left join bankbranch b2 on b.branchid =b2.id left join bank b3 on b2.bankid =b3.id&quot;);</span>
<span class="nc" id="L2276">    	queryMain=this.persistenceService.getSession().createSQLQuery(query1.toString());</span>
<span class="nc" id="L2277">    	list1 = queryMain.list();</span>
<span class="nc" id="L2278">    	System.out.println(&quot;::Size:: &quot;+list1.size());</span>
<span class="nc bnc" id="L2279" title="All 2 branches missed.">    	if(list1.size()!=0) {</span>
<span class="nc bnc" id="L2280" title="All 2 branches missed.">    		for(Object[] e : list1)</span>
	    	{
<span class="nc" id="L2282">    			String s=null;</span>
<span class="nc" id="L2283">    			s=e[0].toString()+&quot;-&quot;+e[1].toString()+&quot;-&quot;+e[2].toString();</span>
<span class="nc" id="L2284">    			System.out.println(&quot;:::::Bank::::: &quot;+s);</span>
<span class="nc" id="L2285">    			banklist.add(s);</span>
    			
<span class="nc" id="L2287">	    	}</span>
    	}
<span class="nc" id="L2289">    	return banklist;</span>
    }
    
    private String getDateQuery(final Date dateFrom, final Date dateTo) {
<span class="nc" id="L2293">		final StringBuffer numDateQuery = new StringBuffer();</span>
		try {

<span class="nc bnc" id="L2296" title="All 2 branches missed.">			if (null != dateFrom)</span>
<span class="nc" id="L2297">				numDateQuery.append(&quot; and date(mrd.receipt_date) &gt;='&quot;).append(DDMMYYYYFORMAT1.format(dateFrom)).append(&quot;'&quot;);</span>
<span class="nc bnc" id="L2298" title="All 2 branches missed.">			if (null != dateTo)</span>
<span class="nc" id="L2299">				numDateQuery.append(&quot; and date(mrd.receipt_date)  &lt;='&quot;).append(DDMMYYYYFORMAT1.format(dateTo)).append(&quot;'&quot;);</span>

<span class="nc" id="L2301">		} catch (final Exception e) {</span>
<span class="nc" id="L2302">			e.printStackTrace();</span>
<span class="nc" id="L2303">		}</span>
<span class="nc" id="L2304">		return numDateQuery.toString();</span>
	}
    
    private void getServiceCategoryList() {
<span class="nc" id="L2308">		List&lt;BusinessService&gt; businessService = microserviceUtils.getBusinessService(null);</span>
<span class="nc bnc" id="L2309" title="All 2 branches missed.">		for (BusinessService bs : businessService) {</span>
<span class="nc" id="L2310">			String[] splitServName = bs.getBusinessService().split(Pattern.quote(&quot;.&quot;));</span>
<span class="nc" id="L2311">			String[] splitSerCode = bs.getCode().split(Pattern.quote(&quot;.&quot;));</span>
<span class="nc bnc" id="L2312" title="All 4 branches missed.">			if (splitServName.length == 2 &amp;&amp; splitSerCode.length == 2) {</span>
<span class="nc bnc" id="L2313" title="All 2 branches missed.">				if (!serviceCategoryNames.containsKey(splitSerCode[0])) {</span>
<span class="nc" id="L2314">					serviceCategoryNames.put(splitSerCode[0], splitServName[0]);</span>
				}
<span class="nc bnc" id="L2316" title="All 2 branches missed.">				if (serviceTypeMap.containsKey(splitSerCode[0])) {</span>
<span class="nc" id="L2317">					Map&lt;String, String&gt; map = serviceTypeMap.get(splitSerCode[0]);</span>
<span class="nc" id="L2318">					map.put(splitSerCode[1], splitServName[1]);</span>
<span class="nc" id="L2319">					serviceTypeMap.put(splitSerCode[0], map);</span>
<span class="nc" id="L2320">				} else {</span>
<span class="nc" id="L2321">					Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2322">					map.put(splitSerCode[1], splitServName[1]);</span>
<span class="nc" id="L2323">					serviceTypeMap.put(splitSerCode[0], map);</span>
<span class="nc" id="L2324">				}</span>
			} else {
<span class="nc" id="L2326">				serviceCategoryNames.put(splitSerCode[0], splitServName[0]);</span>
			}
<span class="nc" id="L2328">		}</span>
<span class="nc" id="L2329">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>